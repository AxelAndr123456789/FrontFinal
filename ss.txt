import 'dart:math' as math;
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:google_maps_flutter/google_maps_flutter.dart';

void main() {
  runApp(const HealthConnectApp());
}

class SplashScreen extends StatefulWidget {
  const SplashScreen({super.key});

  @override
  State<SplashScreen> createState() => _SplashScreenState();
}

class _SplashScreenState extends State<SplashScreen> with TickerProviderStateMixin {
  late AnimationController _logoController;
  late AnimationController _textController;
  late AnimationController _pulseController;
  late AnimationController _waveController;
  
  late Animation<double> _logoScale;
  late Animation<double> _logoRotation;
  late Animation<double> _textFade;
  late Animation<Offset> _textSlide;
  late Animation<double> _pulseScale;
  late Animation<double> _waveAnimation;

  @override
  void initState() {
    super.initState();
    
    _logoController = AnimationController(
      duration: const Duration(milliseconds: 1200),
      vsync: this,
    );
    
    _textController = AnimationController(
      duration: const Duration(milliseconds: 800),
      vsync: this,
    );
    
    _pulseController = AnimationController(
      duration: const Duration(milliseconds: 1500),
      vsync: this,
    )..repeat(reverse: true);
    
    _waveController = AnimationController(
      duration: const Duration(milliseconds: 2000),
      vsync: this,
    )..repeat();

    _logoScale = Tween<double>(begin: 0.0, end: 1.0).animate(
      CurvedAnimation(parent: _logoController, curve: Curves.elasticOut),
    );
    
    _logoRotation = Tween<double>(begin: -0.5, end: 0.0).animate(
      CurvedAnimation(parent: _logoController, curve: Curves.easeOut),
    );

    _textFade = Tween<double>(begin: 0.0, end: 1.0).animate(
      CurvedAnimation(parent: _textController, curve: Curves.easeIn),
    );
    
    _textSlide = Tween<Offset>(
      begin: const Offset(0, 0.5),
      end: Offset.zero,
    ).animate(CurvedAnimation(parent: _textController, curve: Curves.easeOut));

    _pulseScale = Tween<double>(begin: 1.0, end: 1.15).animate(
      CurvedAnimation(parent: _pulseController, curve: Curves.easeInOut),
    );
    
    _waveAnimation = Tween<double>(begin: 0.0, end: 1.0).animate(
      CurvedAnimation(parent: _waveController, curve: Curves.linear),
    );

    _startAnimations();
  }

  void _startAnimations() async {
    await Future.delayed(const Duration(milliseconds: 200));
    _logoController.forward();
    await Future.delayed(const Duration(milliseconds: 600));
    _textController.forward();
    
    Future.delayed(const Duration(seconds: 3), () {
      if (mounted) {
        Navigator.pushReplacement(
          context,
          PageRouteBuilder(
            pageBuilder: (context, animation, secondaryAnimation) => const HealthConnectLogin(),
            transitionsBuilder: (context, animation, secondaryAnimation, child) {
              return FadeTransition(opacity: animation, child: child);
            },
            transitionDuration: const Duration(milliseconds: 500),
          ),
        );
      }
    });
  }

  @override
  void dispose() {
    _logoController.dispose();
    _textController.dispose();
    _pulseController.dispose();
    _waveController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: Stack(
        children: [
          Container(
            decoration: const BoxDecoration(
              gradient: LinearGradient(
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
                colors: [
                  Color(0xFF667eea),
                  Color(0xFF764ba2),
                  Color(0xFF7c4dff),
                ],
              ),
            ),
            child: AnimatedBuilder(
              animation: _waveAnimation,
              builder: (context, child) {
                return CustomPaint(
                  painter: WavePainter(
                    animation: _waveAnimation.value,
                    color: Colors.white.withValues(alpha: 0.1),
                  ),
                  size: Size.infinite,
                );
              },
            ),
          ),
          Container(
            decoration: BoxDecoration(
              gradient: RadialGradient(
                center: const Alignment(0, -0.5),
                radius: 1.5,
                colors: [
                  Colors.white.withValues(alpha: 0.2),
                  Colors.transparent,
                ],
              ),
            ),
          ),
          Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                AnimatedBuilder(
                  animation: _pulseController,
                  builder: (context, child) {
                    return Transform.scale(
                      scale: _pulseScale.value,
                      child: child,
                    );
                  },
                  child: AnimatedBuilder(
                    animation: _logoController,
                    builder: (context, child) {
                      return Transform.scale(
                        scale: _logoScale.value,
                        child: Transform.rotate(
                          angle: _logoRotation.value,
                          child: child,
                        ),
                      );
                    },
                    child: Container(
                      width: 140,
                      height: 140,
                      decoration: BoxDecoration(
                        color: Colors.white,
                        borderRadius: BorderRadius.circular(40),
                        boxShadow: [
                          BoxShadow(
                            color: Colors.black.withValues(alpha: 0.3),
                            blurRadius: 30,
                            offset: const Offset(0, 15),
                          ),
                          BoxShadow(
                            color: const Color(0xFF7c4dff).withValues(alpha: 0.5),
                            blurRadius: 60,
                            spreadRadius: 5,
                          ),
                        ],
                      ),
                      child: Stack(
                        alignment: Alignment.center,
                        children: [
                          Container(
                            width: 80,
                            height: 80,
                            decoration: BoxDecoration(
                              gradient: const LinearGradient(
                                colors: [Color(0xFF667eea), Color(0xFF7c4dff)],
                              ),
                              borderRadius: BorderRadius.circular(20),
                            ),
                            child: const Icon(
                              Icons.favorite,
                              color: Colors.white,
                              size: 45,
                            ),
                          ),
                          Positioned(
                            bottom: 25,
                            right: 25,
                            child: Container(
                              padding: const EdgeInsets.all(6),
                              decoration: BoxDecoration(
                                color: const Color(0xFF4caf50),
                                borderRadius: BorderRadius.circular(12),
                                border: Border.all(color: Colors.white, width: 2),
                              ),
                              child: const Icon(
                                Icons.check,
                                color: Colors.white,
                                size: 14,
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
                ),
                const SizedBox(height: 40),
                SlideTransition(
                  position: _textSlide,
                  child: FadeTransition(
                    opacity: _textFade,
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
                        const Text(
                          'HealthConnect',
                          style: TextStyle(
                            color: Colors.white,
                            fontSize: 36,
                            fontWeight: FontWeight.bold,
                            letterSpacing: 2,
                            shadows: [
                              Shadow(
                                color: Colors.black26,
                                offset: Offset(0, 4),
                                blurRadius: 10,
                              ),
                            ],
                          ),
                        ),
                        const SizedBox(height: 12),
                        Container(
                          padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 8),
                          decoration: BoxDecoration(
                            color: Colors.white.withValues(alpha: 0.15),
                            borderRadius: BorderRadius.circular(30),
                          ),
                          child: const Text(
                            'Tu salud, nuestra prioridad',
                            style: TextStyle(
                              color: Colors.white,
                              fontSize: 16,
                              fontWeight: FontWeight.w400,
                            ),
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
                const SizedBox(height: 60),
                FadeTransition(
                  opacity: _textFade,
                  child: Column(
                    children: [
                      SizedBox(
                        width: 50,
                        height: 50,
                        child: CircularProgressIndicator(
                          valueColor: AlwaysStoppedAnimation<Color>(
                            Colors.white.withValues(alpha: 0.8),
                          ),
                          strokeWidth: 3,
                        ),
                      ),
                      const SizedBox(height: 15),
                      Text(
                        'Cargando...',
                        style: TextStyle(
                          color: Colors.white.withValues(alpha: 0.7),
                          fontSize: 14,
                          letterSpacing: 1,
                        ),
                      ),
                    ],
                  ),
                ),
              ],
            ),
          ),
          Positioned(
            bottom: -50,
            left: -50,
            child: AnimatedBuilder(
              animation: _waveAnimation,
              builder: (context, child) {
                return Transform.translate(
                  offset: Offset(_waveAnimation.value * 50, 0),
                  child: child,
                );
              },
              child: Container(
                width: 200,
                height: 200,
                decoration: BoxDecoration(
                  shape: BoxShape.circle,
                  color: Colors.white.withValues(alpha: 0.1),
                ),
              ),
            ),
          ),
          Positioned(
            top: -30,
            right: -30,
            child: AnimatedBuilder(
              animation: _waveAnimation,
              builder: (context, child) {
                return Transform.translate(
                  offset: Offset(-_waveAnimation.value * 30, _waveAnimation.value * 20),
                  child: child,
                );
              },
              child: Container(
                width: 150,
                height: 150,
                decoration: BoxDecoration(
                  shape: BoxShape.circle,
                  color: Colors.white.withValues(alpha: 0.08),
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }
}

class WavePainter extends CustomPainter {
  final double animation;
  final Color color;

  WavePainter({required this.animation, required this.color});

  @override
  void paint(Canvas canvas, Size size) {
    final paint = Paint()
      ..color = color
      ..style = PaintingStyle.fill;

    final path = Path();
    path.moveTo(0, size.height * 0.7);
    
    for (double i = 0; i <= size.width; i++) {
      path.lineTo(
        i,
        size.height * 0.7 + 
        20 * math.sin((i / size.width * 2 * math.pi) + (animation * 2 * math.pi)),
      );
    }
    
    path.lineTo(size.width, size.height);
    path.lineTo(0, size.height);
    path.close();

    canvas.drawPath(path, paint);
  }

  @override
  bool shouldRepaint(covariant WavePainter oldDelegate) {
    return oldDelegate.animation != animation;
  }
}

class HealthConnectApp extends StatelessWidget {
  const HealthConnectApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      title: 'HealthConnect',
      debugShowCheckedModeBanner: false,
      theme: ThemeData(
        colorScheme: ColorScheme.fromSeed(
          seedColor: const Color(0xFF7c4dff),
          brightness: Brightness.light,
        ),
        useMaterial3: true,
        fontFamily: 'Manrope',
        appBarTheme: const AppBarTheme(
          backgroundColor: Colors.white,
          elevation: 1,
          centerTitle: true,
          iconTheme: IconThemeData(color: Color(0xFF333333)),
          titleTextStyle: TextStyle(
            fontSize: 18,
            fontWeight: FontWeight.w600,
            color: Color(0xFF333333),
          ),
        ),
      ),
      home: const SplashScreen(),
    );
  }
}

// ------------------------------------------------------------
// PANTALLA DE LOGIN
// ------------------------------------------------------------
class HealthConnectLogin extends StatefulWidget {
  const HealthConnectLogin({super.key});

  @override
  State<HealthConnectLogin> createState() => _HealthConnectLoginState();
}

class _HealthConnectLoginState extends State<HealthConnectLogin> {
  final TextEditingController _emailController = TextEditingController();
  final TextEditingController _passwordController = TextEditingController();
  final String _simulatedEmail = "usuario@healthconnect.com";
  final String _simulatedPassword = "Password123";
  bool _isLoading = false;
  String _errorMessage = '';
  bool _showPassword = false;

  Future<void> _attemptLogin(BuildContext context) async {
    final email = _emailController.text.trim();
    final password = _passwordController.text.trim();

    if (email.isEmpty || password.isEmpty) {
      setState(() {
        _errorMessage = 'Por favor, completa todos los campos';
      });
      return;
    }

    if (!email.contains('@') && !RegExp(r'^[a-zA-Z0-9_]+$').hasMatch(email)) {
      setState(() {
        _errorMessage = 'Ingresa un correo o nombre de usuario válido';
      });
      return;
    }

    if (password.length < 6) {
      setState(() {
        _errorMessage = 'La contraseña debe tener al menos 6 caracteres';
      });
      return;
    }

    setState(() {
      _isLoading = true;
      _errorMessage = '';
    });

await Future.delayed(const Duration(seconds: 2));

    if (!mounted) return;

    if (email == _simulatedEmail && password == _simulatedPassword) {
      await Future.delayed(const Duration(seconds: 2));
      
      if (!mounted) return;
      
      // flutter_lints workaround: mounted check is present above
      // ignore: use_build_context_synchronously
      WidgetsBinding.instance.addPostFrameCallback((_) {
        Navigator.pushReplacement(
          context,
          MaterialPageRoute(builder: (context) => const MainNavigationScreen()),
        );
      });
    } else {
      setState(() {
        _errorMessage = 'Correo o contraseña incorrectos';
        _isLoading = false;
      });
    }
  }

  @override
  void dispose() {
    _emailController.dispose();
    _passwordController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: const Color(0xFF1c1122),
      body: SafeArea(
        child: LayoutBuilder(
          builder: (context, constraints) {
            final availableHeight = constraints.maxHeight;
            final imageHeight = availableHeight * 0.32;
            final isSmallScreen = availableHeight < 600;
            
            return SingleChildScrollView(
              child: ConstrainedBox(
                constraints: BoxConstraints(minHeight: availableHeight),
                child: Padding(
                  padding: EdgeInsets.symmetric(horizontal: isSmallScreen ? 16 : 20),
                  child: Column(
                    children: [
                      Container(
                        height: imageHeight,
                        width: double.infinity,
                        decoration: BoxDecoration(
                          borderRadius: const BorderRadius.only(
                            bottomLeft: Radius.circular(20),
                            bottomRight: Radius.circular(20),
                          ),
                          image: DecorationImage(
                            image: NetworkImage(
                              "https://lh3.googleusercontent.com/aida-public/AB6AXuA0jwzYyobfTj0yOxpgXwbEMXRuc9YlJ0fFYXCo6rN3-rnNKLzvJaHK0UqtzNL8h9J3oEzluHK9hNQTgU76AASFQYfreV55JEotgolUH6WGVyF8cmaObzCIJjJNLxCa9zcks9xSUTozmSdBnSv5Y80Dk3BA_xklUGa_WaYlAXQ_ZqqZ8JjeQj7f9hMcwnS9JXol2A4h027zxdtoKjQs_nfV73yXKeB-CqVhdnXse8NOsTJIacB9YHIKnWH51BuGscRwpzVETsvZ80o",
                            ),
                            fit: BoxFit.cover,
                            colorFilter: ColorFilter.mode(
                              Colors.black.withValues(alpha: 0.3),
                              BlendMode.darken,
                            ),
                          ),
                        ),
                        child: Center(
                          child: Container(
                            padding: const EdgeInsets.all(16),
                            child: const Text(
                              "HealthConnect",
                              style: TextStyle(
                                color: Colors.white,
                                fontSize: 28,
                                fontWeight: FontWeight.bold,
                                letterSpacing: 1.5,
                              ),
                            ),
                          ),
                        ),
                      ),

                      SizedBox(height: isSmallScreen ? 15 : 30),

                      const Padding(
                        padding: EdgeInsets.symmetric(horizontal: 20),
                        child: Text(
                          "Bienvenido a HealthConnect",
                          style: TextStyle(
                            color: Colors.white,
                            fontSize: 22,
                            fontWeight: FontWeight.bold,
                          ),
                          textAlign: TextAlign.center,
                        ),
                      ),

                      SizedBox(height: isSmallScreen ? 15 : 30),

                      if (_errorMessage.isNotEmpty)
                        Container(
                          width: double.infinity,
                          padding: const EdgeInsets.all(12),
                          decoration: BoxDecoration(
                            color: const Color(0xFF4a1f1f),
                            borderRadius: BorderRadius.circular(12),
                            border: Border.all(color: const Color(0xFFff6b6b)),
                          ),
                          child: Row(
                            children: [
                              const Icon(
                                Icons.error_outline,
                                color: Color(0xFFff6b6b),
                                size: 20,
                              ),
                              const SizedBox(width: 10),
                              Expanded(
                                child: Text(
                                  _errorMessage,
                                  style: const TextStyle(
                                    color: Color(0xFFffb8b8),
                                    fontSize: 14,
                                  ),
                                ),
                              ),
                              IconButton(
                                onPressed: () {
                                  setState(() {
                                    _errorMessage = '';
                                  });
                                },
                                icon: const Icon(
                                  Icons.close,
                                  color: Color(0xFFff6b6b),
                                  size: 18,
                                ),
                                padding: EdgeInsets.zero,
                                constraints: const BoxConstraints(),
                              ),
                            ],
                          ),
                        ),

                      if (_errorMessage.isNotEmpty) SizedBox(height: isSmallScreen ? 10 : 20),

                      TextField(
                        controller: _emailController,
                        decoration: InputDecoration(
                          filled: true,
                          fillColor: const Color(0xFF3c2348),
                          hintText: "Correo electrónico o nombre de usuario",
                          hintStyle: const TextStyle(color: Color(0xFFb792c9)),
                          border: OutlineInputBorder(
                            borderRadius: BorderRadius.circular(16),
                            borderSide: BorderSide.none,
                          ),
                          contentPadding: const EdgeInsets.symmetric(
                            horizontal: 20,
                            vertical: 18,
                          ),
                          prefixIcon: const Icon(
                            Icons.person_outline,
                            color: Color(0xFFb792c9),
                          ),
                        ),
                        style: const TextStyle(color: Colors.white),
                        keyboardType: TextInputType.emailAddress,
                        textInputAction: TextInputAction.next,
                        enabled: !_isLoading,
                      ),

                      SizedBox(height: isSmallScreen ? 12 : 20),

                      TextField(
                        controller: _passwordController,
                        obscureText: !_showPassword,
                        decoration: InputDecoration(
                          filled: true,
                          fillColor: const Color(0xFF3c2348),
                          hintText: "Contraseña",
                          hintStyle: const TextStyle(color: Color(0xFFb792c9)),
                          border: OutlineInputBorder(
                            borderRadius: BorderRadius.circular(16),
                            borderSide: BorderSide.none,
                          ),
                          contentPadding: const EdgeInsets.symmetric(
                            horizontal: 20,
                            vertical: 18,
                          ),
                          prefixIcon: const Icon(
                            Icons.lock_outline,
                            color: Color(0xFFb792c9),
                          ),
                          suffixIcon: IconButton(
                            onPressed: _isLoading
                                ? null
                                : () {
                                    setState(() {
                                      _showPassword = !_showPassword;
                                    });
                                  },
                            icon: Icon(
                              _showPassword
                                  ? Icons.visibility_off
                                  : Icons.visibility,
                              color: const Color(0xFFb792c9),
                            ),
                          ),
                        ),
                        style: const TextStyle(color: Colors.white),
                        textInputAction: TextInputAction.done,
                        onSubmitted: (_) => _isLoading ? null : _attemptLogin(context),
                        enabled: !_isLoading,
                      ),

                      SizedBox(height: isSmallScreen ? 20 : 30),

                      SizedBox(
                        width: double.infinity,
                        height: 55,
                        child: ElevatedButton(
                          onPressed: _isLoading ? null : () => _attemptLogin(context),
                          style: ElevatedButton.styleFrom(
                            backgroundColor: const Color(0xFF7c4dff),
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(50),
                            ),
                            elevation: 0,
                          ),
                          child: _isLoading
                              ? Row(
                                  mainAxisAlignment: MainAxisAlignment.center,
                                  children: [
                                    const SizedBox(
                                      width: 20,
                                      height: 20,
                                      child: CircularProgressIndicator(
                                        color: Colors.white,
                                        strokeWidth: 2,
                                      ),
                                    ),
                                    const SizedBox(width: 12),
                                    Text(
                                      'Verificando...',
                                      style: TextStyle(
                                        fontSize: 16,
                                        color: Colors.white.withValues(alpha: 0.9),
                                      ),
                                    ),
                                  ],
                                )
                              : const Text(
                                  "Iniciar sesión",
                                  style: TextStyle(
                                    fontSize: 18,
                                    fontWeight: FontWeight.bold,
                                    color: Colors.white,
                                  ),
                                ),
                        ),
                      ),

                      SizedBox(height: isSmallScreen ? 8 : 10),

                      TextButton(
                        onPressed: _isLoading
                            ? null
                            : () {
                                Navigator.push(
                                  context,
                                  MaterialPageRoute(
                                    builder: (context) => const PasswordRecoveryScreen(),
                                  ),
                                );
                              },
                        child: Text(
                          "¿Olvidaste tu contraseña?",
                          style: TextStyle(
                            color: _isLoading
                                ? const Color(0xFFb792c9).withValues(alpha: 0.5)
                                : const Color(0xFFb792c9),
                            decoration: TextDecoration.underline,
                          ),
                        ),
                      ),

                      TextButton(
                        onPressed: _isLoading
                            ? null
                            : () {
                                Navigator.push(
                                  context,
                                  MaterialPageRoute(
                                    builder: (context) => const PatientRegistrationScreen(),
                                  ),
                                );
                              },
                        child: Text(
                          "Crear una cuenta",
                          style: TextStyle(
                            color: _isLoading
                                ? const Color(0xFFb792c9).withValues(alpha: 0.5)
                                : const Color(0xFFb792c9),
                            decoration: TextDecoration.underline,
                          ),
                        ),
                      ),

                      SizedBox(height: isSmallScreen ? 20 : 40),
                    ],
                  ),
                ),
              ),
            );
          },
        ),
      ),
    );
  }
}

// ------------------------------------------------------------
// PANTALLA DE RECUPERACIÓN DE CONTRASEÑA
// ------------------------------------------------------------
class PasswordRecoveryScreen extends StatefulWidget {
  const PasswordRecoveryScreen({super.key});

  @override
  State<PasswordRecoveryScreen> createState() => _PasswordRecoveryScreenState();
}

class _PasswordRecoveryScreenState extends State<PasswordRecoveryScreen> {
  final TextEditingController _emailController = TextEditingController();
  final TextEditingController _passwordController = TextEditingController();
  final TextEditingController _confirmPasswordController = TextEditingController();
  
  bool _isLoading = false;
  String _message = '';
  bool _isSuccess = false;
  bool _isEmailVerified = false;
  bool _obscurePassword = true;
  bool _obscureConfirmPassword = true;
  
  final Color _secondaryColor = const Color(0xFF7c4dff);
  final Color _backgroundColor = const Color(0xFFF6F8F8);
  final Color _cardColor = Colors.white;
  final Color _iconColor = Colors.black;

  Future<void> _verifyEmail() async {
    final email = _emailController.text.trim();

    if (email.isEmpty) {
      setState(() {
        _message = 'Por favor, ingresa tu correo electrónico';
        _isSuccess = false;
      });
      return;
    }

    if (!email.contains('@')) {
      setState(() {
        _message = 'Por favor, ingresa un correo válido';
        _isSuccess = false;
      });
      return;
    }

    setState(() {
      _isLoading = true;
      _message = '';
    });

    await Future.delayed(const Duration(seconds: 1));

    setState(() {
      _isLoading = false;
      _isEmailVerified = true;
      _message = 'Correo verificado, puede continuar';
      _isSuccess = true;
    });
  }

  Future<void> _resetPassword() async {
    final password = _passwordController.text;
    final confirmPassword = _confirmPasswordController.text;

    if (password.isEmpty) {
      setState(() {
        _message = 'Por favor, ingresa una contraseña';
        _isSuccess = false;
      });
      return;
    }

    if (password.length < 6) {
      setState(() {
        _message = 'La contraseña debe tener al menos 6 caracteres';
        _isSuccess = false;
      });
      return;
    }

    if (password != confirmPassword) {
      setState(() {
        _message = 'Las contraseñas no coinciden';
        _isSuccess = false;
      });
      return;
    }

    setState(() {
      _isLoading = true;
      _message = '';
    });

    await Future.delayed(const Duration(seconds: 2));

    setState(() {
      _isLoading = false;
      _message = 'Contraseña restablecida exitosamente';
      _isSuccess = true;
    });

    await Future.delayed(const Duration(seconds: 2));
    
    if (mounted) {
      Navigator.pop(context);
    }
  }

  @override
  void dispose() {
    _emailController.dispose();
    _passwordController.dispose();
    _confirmPasswordController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: _backgroundColor,
      appBar: AppBar(
        backgroundColor: Colors.white,
        elevation: 0,
        leading: IconButton(
          icon: const Icon(Icons.arrow_back, color: Color(0xFF333333)),
          onPressed: () => Navigator.pop(context),
        ),
        title: const Text(
          'Restablecer Contraseña',
          style: TextStyle(
            fontSize: 18,
            fontWeight: FontWeight.w600,
            color: Color(0xFF333333),
          ),
        ),
        centerTitle: true,
      ),
      body: SafeArea(
        child: SingleChildScrollView(
          child: Padding(
            padding: const EdgeInsets.symmetric(horizontal: 24),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                const SizedBox(height: 30),
                
                Container(
                  width: 56,
                  height: 56,
                  decoration: BoxDecoration(
                    color: _secondaryColor.withValues(alpha: 0.1),
                    borderRadius: BorderRadius.circular(16),
                  ),
                  child: Icon(
                    Icons.lock_reset,
                    color: _secondaryColor,
                    size: 28,
                  ),
                ),
                
                const SizedBox(height: 20),
                
                RichText(
                  text: TextSpan(
                    text: 'Restablece tu ',
                    style: TextStyle(
                      fontSize: 28,
                      fontWeight: FontWeight.w800,
                      color: Colors.black,
                      height: 1.2,
                    ),
                    children: [
                      TextSpan(
                        text: 'contraseña',
                        style: TextStyle(
                          fontSize: 28,
                          fontWeight: FontWeight.w800,
                          color: _secondaryColor,
                        ),
                      ),
                    ],
                  ),
                ),
                
                const SizedBox(height: 8),
                
                Text(
                  _isEmailVerified 
                      ? 'Ingresa tu nueva contraseña.'
                      : 'Ingresa tu correo electrónico registrado para verificar tu cuenta.',
                  style: TextStyle(
                    fontSize: 15,
                    color: Colors.grey.shade600,
                  ),
                ),

                const SizedBox(height: 32),

                if (_message.isNotEmpty)
                  Container(
                    width: double.infinity,
                    padding: const EdgeInsets.all(12),
                    margin: const EdgeInsets.only(bottom: 16),
                    decoration: BoxDecoration(
                      color: _isSuccess 
                          ? const Color(0xFFe8f5e9) 
                          : const Color(0xFFffebee),
                      borderRadius: BorderRadius.circular(12),
                      border: Border.all(
                        color: _isSuccess 
                            ? const Color(0xFF4caf50) 
                            : const Color(0xFFef5350),
                      ),
                    ),
                    child: Row(
                      children: [
                        Icon(
                          _isSuccess ? Icons.check_circle : Icons.error_outline,
                          color: _isSuccess 
                              ? const Color(0xFF4caf50) 
                              : const Color(0xFFef5350),
                          size: 20,
                        ),
                        const SizedBox(width: 10),
                        Expanded(
                          child: Text(
                            _message,
                            style: TextStyle(
                              color: _isSuccess 
                                  ? const Color(0xFF2e7d32) 
                                  : const Color(0xFFc62828),
                              fontSize: 14,
                            ),
                          ),
                        ),
                      ],
                    ),
                  ),

                if (!_isEmailVerified) ...[
                  _buildTextField(
                    label: 'Correo Electrónico',
                    hintText: 'usuario@correo.com',
                    controller: _emailController,
                    keyboardType: TextInputType.emailAddress,
                  ),
                  
                  const SizedBox(height: 32),
                  
                  SizedBox(
                    width: double.infinity,
                    height: 56,
                    child: ElevatedButton(
                      onPressed: _isLoading ? null : _verifyEmail,
                      style: ElevatedButton.styleFrom(
                        backgroundColor: _secondaryColor,
                        foregroundColor: Colors.white,
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(16),
                        ),
                        elevation: 4,
                        shadowColor: _secondaryColor.withValues(alpha: 0.3),
                      ),
                      child: _isLoading
                          ? const SizedBox(
                              width: 24,
                              height: 24,
                              child: CircularProgressIndicator(
                                color: Colors.white,
                                strokeWidth: 2,
                              ),
                            )
                          : const Text(
                              'Verificar Correo',
                              style: TextStyle(
                                fontSize: 16,
                                fontWeight: FontWeight.w700,
                              ),
                            ),
                    ),
                  ),
                ] else ...[
                  _buildPasswordField(
                    label: 'Nueva Contraseña',
                    hintText: 'Mínimo 6 caracteres',
                    controller: _passwordController,
                    obscureText: _obscurePassword,
                    toggleObscure: () {
                      setState(() {
                        _obscurePassword = !_obscurePassword;
                      });
                    },
                  ),
                  
                  const SizedBox(height: 20),
                  
                  _buildPasswordField(
                    label: 'Confirmar Contraseña',
                    hintText: 'Repite tu contraseña',
                    controller: _confirmPasswordController,
                    obscureText: _obscureConfirmPassword,
                    toggleObscure: () {
                      setState(() {
                        _obscureConfirmPassword = !_obscureConfirmPassword;
                      });
                    },
                  ),
                  
                  const SizedBox(height: 32),
                  
                  SizedBox(
                    width: double.infinity,
                    height: 56,
                    child: ElevatedButton(
                      onPressed: _isLoading ? null : _resetPassword,
                      style: ElevatedButton.styleFrom(
                        backgroundColor: _secondaryColor,
                        foregroundColor: Colors.white,
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(16),
                        ),
                        elevation: 4,
                        shadowColor: _secondaryColor.withValues(alpha: 0.3),
                      ),
                      child: _isLoading
                          ? const SizedBox(
                              width: 24,
                              height: 24,
                              child: CircularProgressIndicator(
                                color: Colors.white,
                                strokeWidth: 2,
                              ),
                            )
                          : const Text(
                              'Restablecer Contraseña',
                              style: TextStyle(
                                fontSize: 16,
                                fontWeight: FontWeight.w700,
                              ),
                            ),
                    ),
                  ),
                ],

                const SizedBox(height: 24),
                
                Center(
                  child: TextButton(
                    onPressed: () => Navigator.pop(context),
                    child: Text(
                      "Volver al inicio de sesión",
                      style: TextStyle(
                        fontSize: 14,
                        color: _secondaryColor,
                        fontWeight: FontWeight.w600,
                      ),
                    ),
                  ),
                ),

                const SizedBox(height: 40),
              ],
            ),
          ),
        ),
      ),
    );
  }

  Widget _buildTextField({
    required String label,
    required String hintText,
    required TextEditingController controller,
    TextInputType keyboardType = TextInputType.text,
  }) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          label,
          style: TextStyle(
            fontSize: 14,
            fontWeight: FontWeight.w600,
            color: Colors.grey.shade700,
          ),
        ),
        const SizedBox(height: 8),
        Container(
          height: 56,
          decoration: BoxDecoration(
            color: _cardColor,
            borderRadius: BorderRadius.circular(16),
            boxShadow: [
              BoxShadow(
                color: Colors.black.withValues(alpha: 0.05),
                blurRadius: 8,
                offset: const Offset(0, 2),
              ),
            ],
          ),
          child: TextField(
            controller: controller,
            decoration: InputDecoration(
              hintText: hintText,
              hintStyle: TextStyle(
                color: Colors.grey.shade400,
              ),
              border: InputBorder.none,
              contentPadding: const EdgeInsets.symmetric(
                horizontal: 16,
                vertical: 18,
              ),
            ),
            style: TextStyle(
              fontSize: 16,
              color: Colors.black,
            ),
            keyboardType: keyboardType,
          ),
        ),
      ],
    );
  }

  Widget _buildPasswordField({
    required String label,
    required String hintText,
    required TextEditingController controller,
    required bool obscureText,
    required VoidCallback toggleObscure,
  }) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          label,
          style: TextStyle(
            fontSize: 14,
            fontWeight: FontWeight.w600,
            color: Colors.grey.shade700,
          ),
        ),
        const SizedBox(height: 8),
        Container(
          height: 56,
          decoration: BoxDecoration(
            color: _cardColor,
            borderRadius: BorderRadius.circular(16),
            boxShadow: [
              BoxShadow(
                color: Colors.black.withValues(alpha: 0.05),
                blurRadius: 8,
                offset: const Offset(0, 2),
              ),
            ],
          ),
          child: Row(
            children: [
              Expanded(
                child: TextField(
                  controller: controller,
                  obscureText: obscureText,
                  decoration: InputDecoration(
                    hintText: hintText,
                    hintStyle: TextStyle(
                      color: Colors.grey.shade400,
                    ),
                    border: InputBorder.none,
                    contentPadding: const EdgeInsets.symmetric(
                      horizontal: 16,
                      vertical: 18,
                    ),
                  ),
                  style: TextStyle(
                    fontSize: 16,
                    color: Colors.black,
                  ),
                ),
              ),
              IconButton(
                onPressed: toggleObscure,
                icon: Icon(
                  obscureText ? Icons.visibility : Icons.visibility_off,
                  color: _iconColor,
                  size: 20,
                ),
              ),
            ],
          ),
        ),
      ],
    );
  }
}

// ------------------------------------------------------------
// PANTALLA DE REGISTRO DE PACIENTE
// ------------------------------------------------------------
class PatientRegistrationScreen extends StatefulWidget {
  const PatientRegistrationScreen({super.key});

  @override
  State<PatientRegistrationScreen> createState() =>
      _PatientRegistrationScreenState();
}

class _PatientRegistrationScreenState extends State<PatientRegistrationScreen> {
  // Variables de estado para los campos del formulario
  final TextEditingController _nameController = TextEditingController();
  final TextEditingController _dniController = TextEditingController();
  final TextEditingController _birthDateController = TextEditingController();
  final TextEditingController _ageController = TextEditingController();
  final TextEditingController _phoneController = TextEditingController();
  final TextEditingController _addressController = TextEditingController();
  final TextEditingController _emailController = TextEditingController();
  final TextEditingController _passwordController = TextEditingController();

  bool _obscurePassword = true;
  bool _hasNineEntered = false;
  bool _isLoginButtonHovered = false;

  // Colores personalizados
  final Color _secondaryColor = const Color(0xFF7c4dff);
  final Color _backgroundColor = const Color(0xFFF6F8F8);
  final Color _cardColor = Colors.white;
  final Color _iconColor = Colors.black;

  // Variables para el formato de fecha
  final FocusNode _dateFocusNode = FocusNode();
  String _dateText = '';

  // InputFormatter para solo números
  final onlyNumbersFormatter = FilteringTextInputFormatter.digitsOnly;

  @override
  void initState() {
    super.initState();
    _ageController.text = '--';
    
    _birthDateController.addListener(_formatDate);
    _birthDateController.addListener(_calculateAge);
    _phoneController.addListener(_validatePhoneFirstDigit);
  }

  @override
  void dispose() {
    _birthDateController.removeListener(_formatDate);
    _birthDateController.removeListener(_calculateAge);
    _phoneController.removeListener(_validatePhoneFirstDigit);
    _birthDateController.dispose();
    _dniController.dispose();
    _phoneController.dispose();
    _dateFocusNode.dispose();
    super.dispose();
  }

  void _formatDate() {
    final text = _birthDateController.text;
    
    String digits = text.replaceAll(RegExp(r'[^0-9]'), '');
    
    if (digits.length > 8) {
      digits = digits.substring(0, 8);
    }
    
    String formatted = '';
    for (int i = 0; i < digits.length; i++) {
      if (i == 2 || i == 4) {
        formatted += '/';
      }
      
      final char = digits[i];
      if (i == 0) {
        if (int.parse(char) > 3) {
          digits = '${digits.substring(0, i)}3${digits.substring(i + 1)}';
        }
      } else if (i == 1) {
        if (digits.isNotEmpty) {
          final firstDayDigit = int.parse(digits[0]);
          if (firstDayDigit == 0) {
            if (int.parse(char) < 1) {
              digits = '${digits.substring(0, i)}1${digits.substring(i + 1)}';
            }
          } else if (firstDayDigit == 3) {
            if (int.parse(char) > 1) {
              digits = '${digits.substring(0, i)}1${digits.substring(i + 1)}';
            }
          }
        }
      } else if (i == 2) {
        if (int.parse(char) > 1) {
          digits = '${digits.substring(0, i)}1${digits.substring(i + 1)}';
        }
      } else if (i == 3) {
        if (digits.length > 2) {
          final firstMonthDigit = int.parse(digits[2]);
          if (firstMonthDigit == 0) {
            if (int.parse(char) < 1) {
              digits = '${digits.substring(0, i)}1${digits.substring(i + 1)}';
            }
          } else if (firstMonthDigit == 1) {
            if (int.parse(char) > 2) {
              digits = '${digits.substring(0, i)}2${digits.substring(i + 1)}';
            }
          }
        }
      } else if (i == 4) {
        final yearDigit = int.parse(char);
        if (yearDigit < 1) {
          digits = '${digits.substring(0, i)}1${digits.substring(i + 1)}';
        } else if (yearDigit > 2) {
          digits = '${digits.substring(0, i)}2${digits.substring(i + 1)}';
        }
      } else if (i == 5) {
        if (digits.length > 4) {
          final firstYearDigit = int.parse(digits[4]);
          final currentYear = DateTime.now().year;
          final currentFirstTwoDigits = currentYear ~/ 100;
          
          if (firstYearDigit == 2) {
            final maxSecondDigit = (currentFirstTwoDigits % 10).toString();
            if (int.parse(char) > int.parse(maxSecondDigit)) {
              digits = digits.substring(0, i) + maxSecondDigit + digits.substring(i + 1);
            }
          }
        }
      }
      
      formatted += digits[i];
    }
    
    if (formatted != _dateText) {
      _dateText = formatted;
      _birthDateController.value = TextEditingValue(
        text: formatted,
        selection: TextSelection.collapsed(offset: formatted.length),
      );
    }
  }

  bool _isValidDate(String dayStr, String monthStr, String yearStr) {
    try {
      final day = int.parse(dayStr);
      final month = int.parse(monthStr);
      final year = int.parse(yearStr);
      
      final now = DateTime.now();
      
      if (year < 1900 || year > now.year) return false;
      if (month < 1 || month > 12) return false;
      
      final daysInMonth = _getDaysInMonth(month, year);
      if (day < 1 || day > daysInMonth) return false;
      
      final birthDate = DateTime(year, month, day);
      if (birthDate.isAfter(now)) return false;
      
      return true;
    } catch (e) {
      return false;
    }
  }

  int _getDaysInMonth(int month, int year) {
    if (month == 2) {
      final isLeapYear = (year % 4 == 0 && year % 100 != 0) || (year % 400 == 0);
      return isLeapYear ? 29 : 28;
    } else if ([4, 6, 9, 11].contains(month)) {
      return 30;
    } else {
      return 31;
    }
  }

  void _calculateAge() {
    final text = _birthDateController.text.replaceAll('/', '');
    
    if (text.length == 8) {
      try {
        final dayStr = text.substring(0, 2);
        final monthStr = text.substring(2, 4);
        final yearStr = text.substring(4, 8);
        
        if (!_isValidDate(dayStr, monthStr, yearStr)) {
          _ageController.text = '--';
          if (mounted) {
            setState(() {});
          }
          return;
        }
        
        final day = int.parse(dayStr);
        final month = int.parse(monthStr);
        final year = int.parse(yearStr);
        
        final birthDate = DateTime(year, month, day);
        final now = DateTime.now();
        
        int age = now.year - birthDate.year;
        
        if (now.month < birthDate.month || 
            (now.month == birthDate.month && now.day < birthDate.day)) {
          age--;
        }
        
        if (age >= 0 && age <= 120) {
          _ageController.text = age.toString();
        } else {
          _ageController.text = '--';
        }
        
        if (mounted) {
          setState(() {});
        }
      } catch (e) {
        _ageController.text = '--';
        if (mounted) {
          setState(() {});
        }
      }
    } else {
      _ageController.text = '--';
      if (mounted) {
        setState(() {});
      }
    }
  }

  void _validatePhoneFirstDigit() {
    final text = _phoneController.text;
    
    if (text.isEmpty) {
      setState(() {
        _hasNineEntered = false;
      });
      return;
    }
    
    final digits = text.replaceAll(RegExp(r'[^0-9]'), '');
    
    if (digits.isNotEmpty) {
      if (!_hasNineEntered && digits[0] != '9') {
        _phoneController.clear();
        setState(() {
          _hasNineEntered = false;
        });
        return;
      }
      
      if (digits[0] == '9' && !_hasNineEntered) {
        setState(() {
          _hasNineEntered = true;
        });
      }
      
      if (text != digits) {
        _phoneController.text = digits;
        _phoneController.selection = TextSelection.fromPosition(
          TextPosition(offset: digits.length),
        );
      }
    }
  }

  final _phoneStartsWithNineFormatter = _PhoneStartsWithNineFormatter();

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: _backgroundColor,
      appBar: AppBar(
        backgroundColor: Colors.white,
        elevation: 0,
        leading: IconButton(
          icon: const Icon(Icons.arrow_back, color: Color(0xFF333333)),
          onPressed: () => Navigator.pop(context),
        ),
        title: const Text(
          'Registro de Paciente',
          style: TextStyle(
            fontSize: 18,
            fontWeight: FontWeight.w600,
            color: Color(0xFF333333),
          ),
        ),
      ),
      body: SafeArea(
        child: SingleChildScrollView(
          child: Padding(
            padding: const EdgeInsets.symmetric(horizontal: 24),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Container(
                  width: 48,
                  height: 48,
                  decoration: BoxDecoration(
                    color: _secondaryColor.withValues(alpha: 0.1),
                    borderRadius: BorderRadius.circular(12),
                  ),
                  child: Icon(
                    Icons.person_add,
                    color: _secondaryColor,
                    size: 24,
                  ),
                ),
                const SizedBox(height: 16),
                RichText(
                  text: TextSpan(
                    text: 'Crea tu ',
                    style: TextStyle(
                      fontSize: 32,
                      fontWeight: FontWeight.w800,
                      color: Colors.black,
                      height: 1.2,
                    ),
                    children: [
                      TextSpan(
                        text: 'cuenta',
                        style: TextStyle(
                          fontSize: 32,
                          fontWeight: FontWeight.w800,
                          color: _secondaryColor,
                        ),
                      ),
                    ],
                  ),
                ),
                const SizedBox(height: 8),
                Text(
                  'Ingresa tus datos personales para brindarte una atención personalizada.',
                  style: TextStyle(
                    fontSize: 16,
                    color: Colors.grey.shade600,
                  ),
                ),

                const SizedBox(height: 32),

                Text(
                  'Información Personal',
                  style: TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.w600,
                    color: const Color.fromARGB(255, 0, 0, 0),
                  ),
                ),
                const SizedBox(height: 16),

                _buildTextField(
                  label: 'Nombre Completo',
                  hintText: 'Ej. Juan Pérez',
                  controller: _nameController,
                ),
                const SizedBox(height: 16),

                Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      'Número de DNI',
                      style: TextStyle(
                        fontSize: 14,
                        fontWeight: FontWeight.w600,
                        color: Colors.grey.shade700,
                      ),
                    ),
                    const SizedBox(height: 8),
                    Container(
                      height: 56,
                      decoration: BoxDecoration(
                        color: _cardColor,
                        borderRadius: BorderRadius.circular(16),
                        boxShadow: [
                          BoxShadow(
                            color: Colors.black.withValues(alpha: 0.05),
                            blurRadius: 8,
                            offset: const Offset(0, 2),
                          ),
                        ],
                      ),
                      child: TextField(
                        controller: _dniController,
                        decoration: InputDecoration(
                          hintText: '8 dígitos',
                          hintStyle: TextStyle(
                            color: Colors.grey.shade400,
                          ),
                          border: InputBorder.none,
                          contentPadding: const EdgeInsets.symmetric(
                            horizontal: 16,
                            vertical: 18,
                          ),
                        ),
                        style: TextStyle(
                          fontSize: 16,
                          color: Colors.black,
                        ),
                        keyboardType: TextInputType.number,
                        maxLength: 8,
                        inputFormatters: [onlyNumbersFormatter],
                        buildCounter: (
                          BuildContext context, {
                          required int currentLength,
                          required bool isFocused,
                          required int? maxLength,
                        }) {
                          return null;
                        },
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 16),

                Row(
                  children: [
                    Expanded(
                      flex: 2,
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            'Fecha de Nacimiento',
                            style: TextStyle(
                              fontSize: 14,
                              fontWeight: FontWeight.w600,
                              color: Colors.grey.shade700,
                            ),
                          ),
                          const SizedBox(height: 8),
                          Container(
                            height: 56,
                            decoration: BoxDecoration(
                              color: _cardColor,
                              borderRadius: BorderRadius.circular(16),
                              boxShadow: [
                                BoxShadow(
                                  color: Colors.black.withValues(alpha: 0.05),
                                  blurRadius: 8,
                                  offset: const Offset(0, 2),
                                ),
                              ],
                            ),
                            child: TextField(
                              controller: _birthDateController,
                              focusNode: _dateFocusNode,
                              decoration: InputDecoration(
                                hintText: 'DD/MM/AAAA',
                                hintStyle: TextStyle(
                                  color: Colors.grey.shade400,
                                ),
                                border: InputBorder.none,
                                contentPadding: const EdgeInsets.symmetric(
                                  horizontal: 16,
                                  vertical: 18,
                                ),
                                suffixIcon: Icon(
                                  Icons.calendar_today,
                                  color: _iconColor,
                                  size: 20,
                                ),
                              ),
                              style: TextStyle(
                                fontSize: 16,
                                color: Colors.black,
                              ),
                              keyboardType: TextInputType.number,
                              maxLength: 10,
                              inputFormatters: [
                                onlyNumbersFormatter,
                                _DateInputFormatter(),
                              ],
                              buildCounter: (
                                BuildContext context, {
                                required int currentLength,
                                required bool isFocused,
                                required int? maxLength,
                              }) {
                                return null;
                              },
                            ),
                          ),
                        ],
                      ),
                    ),
                    const SizedBox(width: 16),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            'Edad',
                            style: TextStyle(
                              fontSize: 14,
                              fontWeight: FontWeight.w600,
                            ),
                          ),
                          const SizedBox(height: 8),
                          Container(
                            height: 56,
                            decoration: BoxDecoration(
                              color: _cardColor,
                              borderRadius: BorderRadius.circular(16),
                              boxShadow: [
                                BoxShadow(
                                  color: Colors.black.withValues(alpha: 0.05),
                                  blurRadius: 8,
                                  offset: const Offset(0, 2),
                                ),
                              ],
                            ),
                            child: TextField(
                              controller: _ageController,
                              readOnly: true,
                              textAlign: TextAlign.center,
                              decoration: InputDecoration(
                                hintText: '--',
                                hintStyle: TextStyle(
                                  color: Colors.grey.shade400,
                                  fontWeight: FontWeight.bold,
                                  fontSize: 16,
                                ),
                                border: InputBorder.none,
                                contentPadding: const EdgeInsets.symmetric(
                                  horizontal: 16,
                                  vertical: 18,
                                ),
                              ),
                              style: TextStyle(
                                fontSize: 16,
                                fontWeight: FontWeight.bold,
                                color: _ageController.text == '--' 
                                    ? Colors.grey.shade400
                                    : Colors.black,
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),
                  ],
                ),

                const SizedBox(height: 24),
                Divider(
                  color: Colors.grey.shade200,
                  height: 1,
                ),
                const SizedBox(height: 24),

                Text(
                  'Información de Contacto',
                  style: TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.w600,
                    color: const Color.fromARGB(255, 0, 0, 0),
                  ),
                ),
                const SizedBox(height: 16),

                Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      'Teléfono Móvil',
                      style: TextStyle(
                        fontSize: 14,
                        fontWeight: FontWeight.w600,
                        color: Colors.grey.shade700,
                      ),
                    ),
                    const SizedBox(height: 8),
                    Container(
                      height: 56,
                      decoration: BoxDecoration(
                        color: _cardColor,
                        borderRadius: BorderRadius.circular(16),
                        boxShadow: [
                          BoxShadow(
                            color: Colors.black.withValues(alpha: 0.05),
                            blurRadius: 8,
                            offset: const Offset(0, 2),
                          ),
                        ],
                      ),
                      child: Row(
                        children: [
                          Padding(
                            padding: const EdgeInsets.only(left: 16),
                            child: Text(
                              '+51',
                              style: TextStyle(
                                fontSize: 16,
                                color: Colors.grey.shade400,
                                fontWeight: FontWeight.w500,
                              ),
                            ),
                          ),
                          Expanded(
                            child: TextField(
                              controller: _phoneController,
                              decoration: InputDecoration(
                                hintText: '9XX XXX XXX',
                                hintStyle: TextStyle(
                                  color: Colors.grey.shade400,
                                ),
                                border: InputBorder.none,
                                contentPadding:
                                    const EdgeInsets.symmetric(
                                  horizontal: 12,
                                  vertical: 18,
                                ),
                              ),
                              style: TextStyle(
                                fontSize: 16,
                                color: Colors.black,
                              ),
                              keyboardType: TextInputType.phone,
                              maxLength: 9,
                              inputFormatters: [
                                onlyNumbersFormatter,
                                _phoneStartsWithNineFormatter,
                              ],
                              buildCounter: (
                                BuildContext context, {
                                required int currentLength,
                                required bool isFocused,
                                required int? maxLength,
                              }) {
                                return null;
                              },
                            ),
                          ),
                        ],
                      ),
                    ),
                    Padding(
                      padding: const EdgeInsets.only(top: 4, left: 4),
                      child: Text(
                        'Debe comenzar con el número 9',
                        style: TextStyle(
                          fontSize: 12,
                          color: Colors.grey.shade500,
                        ),
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 16),

                _buildTextField(
                  label: 'Dirección Residencial',
                  hintText: 'Ej. Av. Larco 123, Miraflores',
                  controller: _addressController,
                ),
                const SizedBox(height: 16),

                _buildTextField(
                  label: 'Correo Electrónico',
                  hintText: 'usuario@correo.com',
                  controller: _emailController,
                  keyboardType: TextInputType.emailAddress,
                ),
                const SizedBox(height: 16),

                Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      'Contraseña',
                      style: TextStyle(
                        fontSize: 14,
                        fontWeight: FontWeight.w600,
                        color: Colors.grey.shade700,
                      ),
                    ),
                    const SizedBox(height: 8),
                    Container(
                      height: 56,
                      decoration: BoxDecoration(
                        color: _cardColor,
                        borderRadius: BorderRadius.circular(16),
                        boxShadow: [
                          BoxShadow(
                            color: Colors.black.withValues(alpha: 0.05),
                            blurRadius: 8,
                            offset: const Offset(0, 2),
                          ),
                        ],
                      ),
                      child: Row(
                        children: [
                          Expanded(
                            child: TextField(
                              controller: _passwordController,
                              obscureText: _obscurePassword,
                              decoration: InputDecoration(
                                hintText: 'Mínimo 8 caracteres',
                                hintStyle: TextStyle(
                                  color: Colors.grey.shade400,
                                ),
                                border: InputBorder.none,
                                contentPadding:
                                    const EdgeInsets.symmetric(
                                  horizontal: 16,
                                  vertical: 18,
                                ),
                              ),
                              style: TextStyle(
                                fontSize: 16,
                                color: Colors.black,
                              ),
                            ),
                          ),
                          IconButton(
                            onPressed: () {
                              setState(() {
                                _obscurePassword = !_obscurePassword;
                              });
                            },
                            icon: Icon(
                              _obscurePassword
                                  ? Icons.visibility
                                  : Icons.visibility_off,
                              color: _iconColor,
                              size: 20,
                            ),
                          ),
                        ],
                      ),
                    ),
                  ],
                ),

                const SizedBox(height: 40),
                SizedBox(
                  width: double.infinity,
                  height: 64,
                  child: ElevatedButton(
                    onPressed: () {
if (_validateForm()) {
                        // print('Registro exitoso');
                        Navigator.pushAndRemoveUntil(
                          context,
                          MaterialPageRoute(builder: (context) => const HealthConnectLogin()),
                          (route) => false,
                        );
                      }
                    },
                    style: ElevatedButton.styleFrom(
                      backgroundColor: _secondaryColor,
                      foregroundColor: Colors.white,
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(16),
                      ),
                      elevation: 8,
                      shadowColor: _secondaryColor.withValues(alpha: 0.2),
                    ),
                    child: const Text(
                      'CREAR CUENTA',
                      style: TextStyle(
                        fontSize: 18,
                        fontWeight: FontWeight.w800,
                      ),
                    ),
                  ),
                ),
                const SizedBox(height: 24),
                Center(
                  child: Wrap(
                    alignment: WrapAlignment.center,
                    crossAxisAlignment: WrapCrossAlignment.center,
                    children: [
                      Text(
                        '¿Ya tienes una cuenta? ',
                        style: TextStyle(
                          fontSize: 14,
                          color: Colors.grey.shade500,
                        ),
                      ),
                      MouseRegion(
                        onEnter: (_) {
                          setState(() {
                            _isLoginButtonHovered = true;
                          });
                        },
                        onExit: (_) {
                          setState(() {
                            _isLoginButtonHovered = false;
                          });
                        },
                        child: AnimatedContainer(
                          duration: const Duration(milliseconds: 200),
                          padding: const EdgeInsets.symmetric(
                            horizontal: 8,
                            vertical: 4,
                          ),
                          decoration: BoxDecoration(
                            color: _isLoginButtonHovered
                                ? _secondaryColor.withValues(alpha: 0.1)
                                : Colors.transparent,
                            borderRadius: BorderRadius.circular(8),
                          ),
                          child: InkWell(
                            onTap: () {
                              Navigator.pop(context);
                            },
                            splashColor: _secondaryColor.withValues(alpha: 0.3),
                            highlightColor:
                                _secondaryColor.withValues(alpha: 0.2),
                            borderRadius: BorderRadius.circular(8),
                            child: Padding(
                              padding: const EdgeInsets.all(4),
                              child: AnimatedDefaultTextStyle(
                                duration: const Duration(milliseconds: 200),
                                style: TextStyle(
                                  fontSize: 14,
                                  color: _isLoginButtonHovered
                                      ? _secondaryColor.withValues(alpha: 0.9)
                                      : _secondaryColor,
                                  fontWeight: FontWeight.w700,
                                  decoration: TextDecoration.underline,
                                  decorationColor: _secondaryColor,
                                  decorationThickness: 1.5,
                                ),
                                child: const Text('Volver al inicio de sesión'),
                              ),
                            ),
                          ),
                        ),
                      ),
                    ],
                  ),
                ),

                const SizedBox(height: 40),
              ],
            ),
          ),
        ),
      ),
    );
  }

  bool _validateForm() {
    if (_nameController.text.isEmpty) {
      _showErrorDialog('Por favor, ingresa tu nombre completo');
      return false;
    }
    
    if (_dniController.text.length != 8) {
      _showErrorDialog('El DNI debe tener 8 dígitos');
      return false;
    }
    
    if (_birthDateController.text.length != 10) {
      _showErrorDialog('Por favor, ingresa una fecha de nacimiento válida (DD/MM/AAAA)');
      return false;
    }
    
    if (_phoneController.text.length != 9) {
      _showErrorDialog('El teléfono debe tener 9 dígitos');
      return false;
    }
    
    if (_emailController.text.isEmpty || !_emailController.text.contains('@')) {
      _showErrorDialog('Por favor, ingresa un correo electrónico válido');
      return false;
    }
    
    if (_passwordController.text.length < 8) {
      _showErrorDialog('La contraseña debe tener al menos 8 caracteres');
      return false;
    }
    
    return true;
  }

  void _showErrorDialog(String message) {
    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        title: const Text('Error de validación'),
        content: Text(message),
        actions: [
          TextButton(
            onPressed: () => Navigator.pop(context),
            child: const Text('OK'),
          ),
        ],
      ),
    );
  }

  Widget _buildTextField({
    required String label,
    required String hintText,
    required TextEditingController controller,
    TextInputType keyboardType = TextInputType.text,
  }) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          label,
          style: TextStyle(
            fontSize: 14,
            fontWeight: FontWeight.w600,
            color: Colors.grey.shade700,
          ),
        ),
        const SizedBox(height: 8),
        Container(
          height: 56,
          decoration: BoxDecoration(
            color: _cardColor,
            borderRadius: BorderRadius.circular(16),
            boxShadow: [
              BoxShadow(
                color: Colors.black.withValues(alpha: 0.05),
                blurRadius: 8,
                offset: const Offset(0, 2),
              ),
            ],
          ),
          child: TextField(
            controller: controller,
            decoration: InputDecoration(
              hintText: hintText,
              hintStyle: TextStyle(
                color: Colors.grey.shade400,
              ),
              border: InputBorder.none,
              contentPadding: const EdgeInsets.symmetric(
                horizontal: 16,
                vertical: 18,
              ),
            ),
            style: TextStyle(
              fontSize: 16,
              color: Colors.black,
            ),
            keyboardType: keyboardType,
          ),
        ),
      ],
    );
  }
}

// ------------------------------------------------------------
// PANTALLA PRINCIPAL DE NAVEGACIÓN
// ------------------------------------------------------------
class MainNavigationScreen extends StatefulWidget {
  const MainNavigationScreen({super.key});

  @override
  State<MainNavigationScreen> createState() => _MainNavigationScreenState();
}

class _MainNavigationScreenState extends State<MainNavigationScreen> {
  int _selectedIndex = 0;

  final List<Widget> _screens = [
    const SpecialtiesScreen(),
    const MyAppointmentsScreen(),
    const CampaignsScreen(), // Nueva pantalla de Campañas
    const HospitalInfoScreen(), // Información sin campañas
    const ProfileScreen(),
  ];

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      body: _screens[_selectedIndex],
      bottomNavigationBar: _buildBottomNavigationBar(),
    );
  }

  BottomNavigationBar _buildBottomNavigationBar() {
    return BottomNavigationBar(
      currentIndex: _selectedIndex,
      onTap: (index) {
        setState(() {
          _selectedIndex = index;
        });
      },
      type: BottomNavigationBarType.fixed,
      backgroundColor: Colors.white,
      selectedItemColor: const Color(0xFF7c4dff),
      unselectedItemColor: Colors.grey[600],
      selectedFontSize: 12,
      unselectedFontSize: 12,
      items: const [
        BottomNavigationBarItem(
          icon: Icon(Icons.home_outlined),
          activeIcon: Icon(Icons.home),
          label: 'Inicio',
        ),
        BottomNavigationBarItem(
          icon: Icon(Icons.calendar_today_outlined),
          activeIcon: Icon(Icons.calendar_today),
          label: 'Citas',
        ),
        BottomNavigationBarItem(
          icon: Icon(Icons.campaign_outlined),
          activeIcon: Icon(Icons.campaign),
          label: 'Campañas',
        ),
        BottomNavigationBarItem(
          icon: Icon(Icons.info_outline),
          activeIcon: Icon(Icons.info),
          label: 'Información',
        ),
        BottomNavigationBarItem(
          icon: Icon(Icons.person_outline),
          activeIcon: Icon(Icons.person),
          label: 'Perfil',
        ),
      ],
    );
  }
}

// ------------------------------------------------------------
// PANTALLA DE CAMPAÑAS (NUEVA)
// ------------------------------------------------------------
class CampaignsScreen extends StatefulWidget {
  const CampaignsScreen({super.key});

  @override
  State<CampaignsScreen> createState() => _CampaignsScreenState();
}

class _CampaignsScreenState extends State<CampaignsScreen> {
  IconData _obtenerIconoCampana(int id) {
    switch (id) {
      case 1:
        return Icons.female;
      case 2:
        return Icons.vaccines;
      case 3:
        return Icons.child_care;
      default:
        return Icons.local_hospital;
    }
  }

  final List<Map<String, dynamic>> _campanas = [
    {
      'id': 1,
      'titulo': 'Feliz Día de la Mujer',
      'subtitulo': 'Campaña de salud - ¡Ven y Hazte tu descarte!',
      'imagen': 'assets/images/campanas/campa.jpg',
      'servicios': ['Toma de PAP', 'IVAA', 'Planificación Familiar', 'Tamizaje VIH', 'Sífilis', 'Hepatitis B', 'Atención Adolescente'],
      'fecha': 'Marzo 2024',
      'lugar': 'Hospital Regional El Carmen',
      'horario': '8:00 AM - 4:00 PM',
      'telefono': '064-231234',
    },
    {
      'id': 2,
      'titulo': 'Campaña contra Hepatitis B',
      'subtitulo': 'Vacunación y prevención gratuita',
      'imagen': 'assets/images/campanas/hepatitis.jpg',
      'servicios': ['Vacunación gratuita', 'Pruebas rápidas', 'Consultas médicas', 'Entrega de medicamentos'],
      'fecha': 'Todo el año',
      'lugar': 'Vacunatorio - Piso 2',
      'horario': 'Lunes a Viernes: 8:00 AM - 3:00 PM',
      'telefono': '064-231567',
    },
    {
      'id': 3,
      'titulo': 'Lactancia Materna',
      'subtitulo': 'Apoyo integral para madres',
      'imagen': 'assets/images/campanas/lactancia.jpg',
      'servicios': ['Talleres educativos', 'Asesoría personalizada', 'Grupos de apoyo', 'Control de crecimiento'],
      'fecha': 'Programa permanente',
      'lugar': 'Pediatría - Piso 3',
      'horario': 'Martes y Jueves: 9:00 AM - 1:00 PM',
      'telefono': '064-231890',
    },
  ];

  Widget _construirCampana(Map<String, dynamic> campana) {
    final int id = campana['id'] is int ? campana['id'] as int : int.tryParse(campana['id'].toString()) ?? 0;
    
    return Card(
      margin: const EdgeInsets.symmetric(vertical: 10),
      elevation: 2,
      shape: RoundedRectangleBorder(
        borderRadius: BorderRadius.circular(12),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.stretch,
        children: [
          ClipRRect(
            borderRadius: const BorderRadius.vertical(top: Radius.circular(12)),
            child: Container(
              height: 160,
              color: const Color(0xFFf3f0ff),
              child: Image.asset(
                campana['imagen'] as String,
                fit: BoxFit.cover,
                errorBuilder: (context, error, stackTrace) {
                  return Container(
                    color: const Color(0xFFf3f0ff),
                    child: Center(
                      child: Column(
                        mainAxisAlignment: MainAxisAlignment.center,
                        children: [
                          Icon(
                            _obtenerIconoCampana(id),
                            size: 48,
                            color: const Color(0xFF7c4dff),
                          ),
                          const SizedBox(height: 10),
                          Padding(
                            padding: const EdgeInsets.symmetric(horizontal: 12.0),
                            child: Text(
                              campana['titulo'] as String,
                              textAlign: TextAlign.center,
                              style: const TextStyle(
                                fontSize: 15,
                                fontWeight: FontWeight.bold,
                                color: Color(0xFF7c4dff),
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),
                  );
                },
              ),
            ),
          ),
          
          Padding(
            padding: const EdgeInsets.all(16),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  campana['titulo'] as String,
                  style: const TextStyle(
                    fontSize: 17,
                    fontWeight: FontWeight.bold,
                    color: Color(0xFF7c4dff),
                  ),
                ),
                
                const SizedBox(height: 6),
                
                Text(
                  campana['subtitulo'] as String,
                  style: const TextStyle(
                    fontSize: 14,
                    color: Color(0xFF651fff),
                    height: 1.3,
                  ),
                ),
                
                const SizedBox(height: 12),
                
                Wrap(
                  spacing: 8,
                  runSpacing: 6,
                  children: (campana['servicios'] as List<dynamic>).map((servicio) {
                    return Chip(
                      label: Text(
                        servicio.toString(),
                        style: const TextStyle(fontSize: 11),
                      ),
                      backgroundColor: const Color(0xFFf3f0ff),
                      labelStyle: const TextStyle(color: Color(0xFF7c4dff)),
                      side: BorderSide.none,
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                      padding: const EdgeInsets.symmetric(horizontal: 10, vertical: 4),
                    );
                  }).toList(),
                ),
                
                const SizedBox(height: 12),
                
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Row(
                            children: [
                              const Icon(Icons.calendar_today, size: 16, color: Color(0xFF7c4dff)),
                              const SizedBox(width: 6),
                              Flexible(
                                child: Text(
                                  campana['fecha'] as String,
                                  style: const TextStyle(fontSize: 13),
                                  overflow: TextOverflow.ellipsis,
                                ),
                              ),
                            ],
                          ),
                          const SizedBox(height: 6),
                          Row(
                            children: [
                              const Icon(Icons.location_on, size: 16, color: Color(0xFF7c4dff)),
                              const SizedBox(width: 6),
                              Flexible(
                                child: Text(
                                  campana['lugar'] as String,
                                  style: const TextStyle(fontSize: 13),
                                  overflow: TextOverflow.ellipsis,
                                ),
                              ),
                            ],
                          ),
                        ],
                      ),
                    ),
                    ElevatedButton(
                      onPressed: () => _verDetallesCampana(campana),
                      style: ElevatedButton.styleFrom(
                        backgroundColor: const Color(0xFF7c4dff),
                        foregroundColor: Colors.white,
                        padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                        shape: RoundedRectangleBorder(
                          borderRadius: BorderRadius.circular(8),
                        ),
                      ),
child: const Text(
                        'Más Información',
                        style: TextStyle(fontSize: 13, fontWeight: FontWeight.w500),
                      ),
                    ),
                  ],
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  void _verDetallesCampana(Map<String, dynamic> campana) {
    showDialog(
      context: context,
      builder: (context) => Dialog(
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(12),
        ),
        child: SingleChildScrollView(
          child: Container(
            padding: const EdgeInsets.all(20),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    Expanded(
                      child: Text(
                        campana['titulo'] as String,
                        style: const TextStyle(
                          fontSize: 18,
                          fontWeight: FontWeight.bold,
                          color: Color(0xFF7c4dff),
                        ),
                      ),
                    ),
                    IconButton(
                      onPressed: () => Navigator.pop(context),
                      icon: const Icon(Icons.close, size: 20),
                      padding: EdgeInsets.zero,
                      constraints: const BoxConstraints(),
                    ),
                  ],
                ),
                
                const SizedBox(height: 8),
                
                Text(
                  campana['subtitulo'] as String,
                  style: const TextStyle(
                    fontSize: 14,
                    color: Color(0xFF651fff),
                  ),
                ),
                
                const SizedBox(height: 16),
                
                Container(
                  height: 120,
                  width: double.infinity,
                  decoration: BoxDecoration(
                    borderRadius: BorderRadius.circular(8),
                    image: DecorationImage(
                      image: AssetImage(campana['imagen'] as String),
                      fit: BoxFit.cover,
                    ),
                  ),
                ),
                
                const SizedBox(height: 16),
                
                const Text(
                  'Servicios incluidos:',
                  style: TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                
                const SizedBox(height: 8),
                
...(campana['servicios'] as List<dynamic>).map((servicio) {
                  return Padding(
                    padding: const EdgeInsets.symmetric(vertical: 4),
                    child: Row(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        const Icon(Icons.check_circle, color: Color(0xFF7c4dff), size: 16),
                        const SizedBox(width: 8),
                        Expanded(
                          child: Text(
                            servicio.toString(),
                            style: const TextStyle(fontSize: 14),
                          ),
                        ),
                      ],
                    ),
                  );
                }),
                
                const SizedBox(height: 16),
                
                Container(
                  padding: const EdgeInsets.all(12),
                  decoration: const BoxDecoration(
                    color: Color(0xFFf3f0ff),
                    borderRadius: BorderRadius.all(Radius.circular(8)),
                  ),
                  child: Column(
                    children: [
                      _detalleCampanaItem(Icons.calendar_today, 'Fecha:', campana['fecha'] as String),
                      const SizedBox(height: 6),
                      _detalleCampanaItem(Icons.access_time, 'Horario:', campana['horario'] as String),
                      const SizedBox(height: 6),
                      _detalleCampanaItem(Icons.location_on, 'Lugar:', campana['lugar'] as String),
                      const SizedBox(height: 6),
                      _detalleCampanaItem(Icons.phone, 'Teléfono:', campana['telefono'] as String),
                    ],
                  ),
                ),
                
                const SizedBox(height: 16),
                
                SizedBox(
                  width: double.infinity,
                  child: ElevatedButton(
                    onPressed: () => Navigator.pop(context),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: const Color(0xFF7c4dff),
                      foregroundColor: Colors.white,
                      padding: const EdgeInsets.symmetric(vertical: 12),
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(8),
                      ),
                    ),
                    child: const Text('Cerrar'),
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  Widget _detalleCampanaItem(IconData icon, String titulo, String valor) {
    return Row(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Icon(icon, size: 16, color: const Color(0xFF7c4dff)),
        const SizedBox(width: 8),
        Expanded(
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Text(
                titulo,
                style: const TextStyle(
                  fontSize: 12,
                  fontWeight: FontWeight.bold,
                  color: Color(0xFF7c4dff),
                ),
              ),
              const SizedBox(height: 2),
              Text(
                valor,
                style: const TextStyle(fontSize: 13),
              ),
            ],
          ),
        ),
      ],
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        leading: IconButton(
          icon: const Icon(Icons.arrow_back, color: Color(0xFF333333)),
          onPressed: () => Navigator.pushReplacement(
            context,
            MaterialPageRoute(builder: (context) => const MainNavigationScreen()),
          ),
        ),
        title: const Text('Campañas'),
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(16.0),
        child: Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            // Título de Campañas con diseño elegante
            Container(
              margin: const EdgeInsets.only(bottom: 16.0),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    'Campañas de Salud 2026',
                    style: TextStyle(
                      fontSize: 22,
                      fontWeight: FontWeight.w700,
                      color: const Color.fromARGB(255, 0, 0, 0),
                      letterSpacing: 0.5,
                    ),
                  ),
                  const SizedBox(height: 6),
                  Container(
                    height: 3,
                    width: 80,
                    decoration: BoxDecoration(
                      color: const Color(0xFF7c4dff),
                      borderRadius: BorderRadius.circular(2),
                    ),
                  ),
                ],
              ),
            ),
            
            const SizedBox(height: 8),
            
            Text(
              'Participa en nuestras campañas de salud gratuitas y mejora tu calidad de vida.',
              style: TextStyle(
                fontSize: 14,
                color: Colors.grey[600],
              ),
            ),
            
            const SizedBox(height: 20),
            
            // Lista de Campañas
            ..._campanas.map((campana) => _construirCampana(campana)),
            
const SizedBox(height: 30),
            
            const SizedBox(height: 20),
          ],
        ),
      ),
    );
  }
}

// ------------------------------------------------------------
// PANTALLA DE INFORMACIÓN DEL HOSPITAL (SIN CAMPAÑAS)
// ------------------------------------------------------------
class HospitalInfoScreen extends StatefulWidget {
  const HospitalInfoScreen({super.key});

  @override
  State<HospitalInfoScreen> createState() => _HospitalInfoScreenState();
}

class _HospitalInfoScreenState extends State<HospitalInfoScreen> {
  GoogleMapController? _mapController;
  final LatLng _hospitalPosition = const LatLng(-12.0700, -75.2144);
  final Set<Marker> _markers = {};

  @override
  void initState() {
    super.initState();
    _configurarMapa();
  }

  @override
  void dispose() {
    _mapController?.dispose();
    super.dispose();
  }

  void _configurarMapa() {
    _markers.add(
      Marker(
        markerId: const MarkerId('hospital_principal'),
        position: _hospitalPosition,
        infoWindow: const InfoWindow(
          title: 'Hospital Regional El Carmen',
          snippet: 'Jirón Puno N° 911, Huancayo - Junín\nAltitud: 2350 m',
        ),
        icon: BitmapDescriptor.defaultMarkerWithHue(BitmapDescriptor.hueViolet),
      ),
    );
  }

  void _onMapCreated(GoogleMapController controller) {
    _mapController = controller;
  }

Widget _buildSectionHeader(String title) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          title,
          style: TextStyle(
            fontSize: 22,
            fontWeight: FontWeight.w700,
            color: const Color.fromARGB(255, 0, 0, 0),
            letterSpacing: 0.5,
          ),
        ),
        const SizedBox(height: 6),
        Container(
          height: 3,
          width: 60,
          decoration: BoxDecoration(
            color: const Color(0xFF7c4dff),
            borderRadius: BorderRadius.circular(2),
          ),
        ),
        const SizedBox(height: 16),
      ],
    );
  }

  Widget _buildServiceRow(IconData icon, String serviceName) {
    return Padding(
      padding: const EdgeInsets.symmetric(vertical: 6),
      child: Row(
        children: [
          Container(
            width: 36,
            height: 36,
            decoration: BoxDecoration(
              color: const Color(0xFF7c4dff).withValues(alpha: 0.1),
              borderRadius: BorderRadius.circular(8),
            ),
            child: Icon(
              icon,
              color: const Color(0xFF7c4dff),
              size: 20,
            ),
          ),
          const SizedBox(width: 12),
          Expanded(
            child: Text(
              serviceName,
              style: TextStyle(
                fontSize: 14,
                color: Colors.grey[700],
              ),
            ),
          ),
        ],
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        leading: IconButton(
          icon: const Icon(Icons.arrow_back, color: Color(0xFF333333)),
          onPressed: () => Navigator.pushReplacement(
            context,
            MaterialPageRoute(builder: (context) => const MainNavigationScreen()),
          ),
        ),
        title: const Text('Información'),
      ),
      body: SingleChildScrollView(
        child: Padding(
          padding: const EdgeInsets.all(16.0),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              // Información del Hospital
              _buildSectionHeader('Información del Hospital'),
              
              Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: Colors.white,
                  borderRadius: BorderRadius.circular(12),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withValues(alpha: 0.05),
                      blurRadius: 8,
                      offset: const Offset(0, 2),
                    ),
                  ],
                ),
                child: const Text(
                  'El Hospital Regional El Carmen es una institución de salud de referencia en la región Junín, comprometida con brindar atención médica integral y de calidad a toda la población. Con más de 35 años de servicio, contamos con tecnología de vanguardia y un equipo humano altamente capacitado para el diagnóstico, tratamiento y prevención de enfermedades.',
                  style: TextStyle(
                    fontSize: 14,
                    color: Color(0xFF666666),
                    height: 1.5,
                  ),
                  textAlign: TextAlign.justify,
                ),
              ),
              
              const SizedBox(height: 24),
              
              // Director General
              _buildSectionHeader('Director General'),

              Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: Colors.white,
                  borderRadius: BorderRadius.circular(12),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withValues(alpha: 0.05),
                      blurRadius: 8,
                      offset: const Offset(0, 2),
                    ),
                  ],
                ),
                child: Column(
                  children: [
                    Container(
                      width: double.infinity,
                      height: 200,
                      decoration: BoxDecoration(
                        borderRadius: BorderRadius.circular(12),
                        color: const Color(0xFFf3f0ff),
                      ),
                      child: ClipRRect(
                        borderRadius: BorderRadius.circular(12),
                        child: Image.asset(
                          'assets/images/campanas/doctor.jpg',
                          fit: BoxFit.cover,
                          errorBuilder: (context, error, stackTrace) {
                            return Container(
                              color: const Color(0xFFf3f0ff),
                              child: const Center(
                                child: Icon(
                                  Icons.person,
                                  size: 50,
                                  color: Color(0xFF7c4dff),
                                ),
                              ),
                            );
                          },
                        ),
                      ),
                    ),
                    const SizedBox(height: 16),
                    const Text(
                      'Dr. Christian Dany Matamoros Vera',
                      style: TextStyle(
                        fontSize: 18,
                        fontWeight: FontWeight.bold,
                        color: Color(0xFF333333),
                      ),
                      textAlign: TextAlign.center,
                    ),
                    const SizedBox(height: 16),
                    const Divider(),
                    const SizedBox(height: 16),
                    const Text(
                      'Con más de 20 años de experiencia en gestión hospitalaria, el Dr. Matamoros Vera ha liderado importantes proyectos de modernización en el Hospital Regional El Carmen. Es especialista en Medicina Interna y cuenta con una Maestría en Administración de Salud. Bajo su dirección, el hospital ha obtenido reconocimientos por su calidad de atención y mejora continua.',
                      style: TextStyle(
                        fontSize: 14,
                        color: Color(0xFF666666),
                        height: 1.5,
                      ),
                      textAlign: TextAlign.justify,
                    ),
                  ],
                ),
              ),
              
              const SizedBox(height: 24),
              
              // Ubicación
              _buildSectionHeader('Ubicación'),
              
              Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: Colors.white,
                  borderRadius: BorderRadius.circular(12),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withValues(alpha: 0.05),
                      blurRadius: 8,
                      offset: const Offset(0, 2),
                    ),
                  ],
                ),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Container(
                      height: 200,
                      decoration: BoxDecoration(
                        borderRadius: BorderRadius.circular(8),
                        boxShadow: [
                          BoxShadow(
                            color: Colors.black.withValues(alpha: 0.1),
                            blurRadius: 4,
                            offset: const Offset(0, 2),
                          ),
                        ],
                      ),
                      child: ClipRRect(
                        borderRadius: BorderRadius.circular(8),
                        child: GoogleMap(
                          onMapCreated: _onMapCreated,
                          initialCameraPosition: CameraPosition(
                            target: _hospitalPosition,
                            zoom: 15.0,
                          ),
                          markers: _markers,
                          mapType: MapType.normal,
                          myLocationEnabled: true,
                          myLocationButtonEnabled: false,
                          zoomControlsEnabled: false,
                          compassEnabled: false,
                          rotateGesturesEnabled: true,
                          scrollGesturesEnabled: true,
                          zoomGesturesEnabled: true,
                          trafficEnabled: false,
                          indoorViewEnabled: false,
                        ),
                      ),
                    ),
                  ],
                ),
              ),
              
const SizedBox(height: 24),
              
              // Dirección
              _buildSectionHeader('Dirección'),
              
              Container(
                width: double.infinity,
                padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
                decoration: BoxDecoration(
                  color: Colors.white,
                  borderRadius: BorderRadius.circular(12),
                  border: Border.all(
                    color: Colors.grey.shade200,
                    width: 1,
                  ),
                ),
                child: const Text(
                  'Jirón Puno N° 911, Huancayo - Junín',
                  style: TextStyle(
                    fontSize: 16,
                    color: Color(0xFF333333),
                  ),
                ),
              ),
              
              const SizedBox(height: 24),
              
// Servicios Destacados
              _buildSectionHeader('Servicios Destacados'),
              
              Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: Colors.white,
                  borderRadius: BorderRadius.circular(12),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withValues(alpha: 0.05),
                      blurRadius: 8,
                      offset: const Offset(0, 2),
                    ),
                  ],
                ),
                child: Column(
                  children: [
                    _buildServiceRow(Icons.local_hospital, 'Emergencias 24h'),
                    _buildServiceRow(Icons.medical_services, 'Cirugía General'),
                    _buildServiceRow(Icons.child_friendly, 'Maternidad'),
                    _buildServiceRow(Icons.child_care, 'Pediatría'),
                    _buildServiceRow(Icons.science, 'Laboratorio Clínico'),
                    _buildServiceRow(Icons.image, 'Imágenes Diagnósticas'),
                    _buildServiceRow(Icons.local_pharmacy, 'Farmacia'),
                    _buildServiceRow(Icons.healing, 'Rehabilitación Física'),
                    _buildServiceRow(Icons.favorite, 'Cardiología'),
                    _buildServiceRow(Icons.psychology, 'Neurología'),
                    _buildServiceRow(Icons.accessibility_new, 'Traumatología'),
                    _buildServiceRow(Icons.wc, 'Urología'),
                    _buildServiceRow(Icons.woman, 'Ginecología'),
                    _buildServiceRow(Icons.remove_red_eye, 'Oftalmología'),
                    _buildServiceRow(Icons.spa, 'Dermatología'),
                    _buildServiceRow(Icons.psychology, 'Psiquiatría'),
                    _buildServiceRow(Icons.medical_information, 'Odontología'),
                    _buildServiceRow(Icons.restaurant, 'Nutrición'),
                    _buildServiceRow(Icons.monitor_heart, 'Endocrinología'),
                  ],
                ),
              ),
              
              const SizedBox(height: 24),
              
              // Para más información
              Container(
                width: double.infinity,
                padding: const EdgeInsets.all(20),
                decoration: BoxDecoration(
                  color: Colors.white,
                  borderRadius: BorderRadius.circular(12),
                  border: Border.all(
                    color: Colors.grey.shade200,
                    width: 1,
                  ),
                ),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.center,
                  mainAxisSize: MainAxisSize.min,
                  children: [
                    Text(
                      'Para más información',
                      style: TextStyle(
                        fontSize: 17,
                        fontWeight: FontWeight.w700,
                        color: const Color(0xFF7c4dff),
                      ),
                      textAlign: TextAlign.center,
                    ),
                    const SizedBox(height: 16),
                    Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Icon(Icons.phone, size: 20, color: const Color(0xFF7c4dff)),
                        const SizedBox(width: 10),
                        Text(
                          'Teléfono: 939873635',
                          style: const TextStyle(fontSize: 15, fontWeight: FontWeight.w500),
                        ),
                      ],
                    ),
                    const SizedBox(height: 10),
                    Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Icon(Icons.email, size: 20, color: const Color(0xFF7c4dff)),
                        const SizedBox(width: 10),
                        Flexible(
                          child: Text(
                            'Email: luisfernando@hospitalelcarmen.gob.pe',
                            style: const TextStyle(fontSize: 15, fontWeight: FontWeight.w500),
                            textAlign: TextAlign.center,
                          ),
                        ),
                      ],
                    ),
                    const SizedBox(height: 10),
                    Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Icon(Icons.language, size: 20, color: const Color(0xFF7c4dff)),
                        const SizedBox(width: 10),
                        Text(
                          'Web: www.hospitalelcarmen.gob.pe',
                          style: const TextStyle(fontSize: 15, fontWeight: FontWeight.w500),
                        ),
                      ],
                    ),
                    const SizedBox(height: 10),
                    Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Icon(Icons.access_time, size: 20, color: const Color(0xFF7c4dff)),
                        const SizedBox(width: 10),
                        Text(
                          'Horario: 24 horas / 7 días a la semana',
                          style: const TextStyle(fontSize: 15, fontWeight: FontWeight.w500),
                        ),
                      ],
                    ),
                  ],
                ),
              ),
              
              const SizedBox(height: 20),
            ],
          ),
        ),
      ),
    );
  }
}

// ------------------------------------------------------------
// PANTALLA DE ESPECIALIDADES (INICIO)
// ------------------------------------------------------------
class SpecialtiesScreen extends StatefulWidget {
  const SpecialtiesScreen({super.key});

  @override
  State<SpecialtiesScreen> createState() => _SpecialtiesScreenState();
}

class _SpecialtiesScreenState extends State<SpecialtiesScreen> {
  final List<Map<String, String>> _allSpecialties = [
    {
      "title": "Cardiología",
      "image": "https://images.unsplash.com/photo-1559757175-5700dde675bc?w=400",
    },
    {
      "title": "Dermatología",
      "image": "https://images.unsplash.com/photo-1612349317150-e413f6a5b16d?w=400",
    },
    {
      "title": "Gastroenterología",
      "image": "https://images.unsplash.com/photo-1581594693702-fbdc51b2763b?w=400",
    },
    {
      "title": "Neurología",
      "image": "https://images.unsplash.com/photo-1559757148-5c350d0d3c56?w=400",
    },
    {
      "title": "Oftalmología",
      "image": "https://images.unsplash.com/photo-1579684385127-1ef15d508118?w=400",
    },
    {
      "title": "Pediatría",
      "image": "https://images.unsplash.com/photo-1581056771107-24ca5f033842?w=400",
    },
    {
      "title": "Endocrinología",
      "image": "https://images.unsplash.com/photo-1576091160399-112ba8d25d1d?w=400",
    },
    {
      "title": "Nefrología",
      "image": "https://images.unsplash.com/photo-1559757175-5700dde675bc?w=400",
    },
    {
      "title": "Psiquiatría",
      "image": "https://images.unsplash.com/photo-1559757148-5c350d0d3c56?w=400",
    },
    {
      "title": "Reumatología",
      "image": "https://images.unsplash.com/photo-1516549655169-df83a0774514?w=400",
    },
    {
      "title": "Urología",
      "image": "https://images.unsplash.com/photo-1579684385127-1ef15d508118?w=400",
    },
    {
      "title": "Angiología",
      "image": "https://images.unsplash.com/photo-1631815588090-d4bfec5b1ccb?w=400",
    },
  ];

  List<Map<String, String>> _filteredSpecialties = [];
  final TextEditingController _searchController = TextEditingController();

  @override
  void initState() {
    super.initState();
    _filteredSpecialties = List.from(_allSpecialties);
  }

  void _filterSpecialties(String query) {
    setState(() {
      if (query.isEmpty) {
        _filteredSpecialties = List.from(_allSpecialties);
      } else {
        _filteredSpecialties = _allSpecialties
            .where((specialty) => specialty["title"]!
                .toLowerCase()
                .contains(query.toLowerCase()))
            .toList();
      }
    });
  }

  void _clearSearch() {
    _searchController.clear();
    _filterSpecialties('');
  }

  void _navigateToAppointmentScreen(String specialty) {
    final appointments = AppointmentsManager().appointments;
    final hasExistingAppointment = appointments.any(
      (appointment) => appointment['specialty'] == specialty,
    );

    if (hasExistingAppointment) {
      showDialog(
        context: context,
        builder: (context) => Dialog(
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(20),
          ),
          child: Container(
            padding: const EdgeInsets.all(24),
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(20),
              color: Colors.white,
            ),
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                Container(
                  width: 70,
                  height: 70,
                  decoration: BoxDecoration(
                    color: const Color(0xFF7c4dff).withValues(alpha: 0.1),
                    borderRadius: BorderRadius.circular(35),
                  ),
                  child: const Icon(
                    Icons.calendar_month,
                    color: Color(0xFF7c4dff),
                    size: 40,
                  ),
                ),
                const SizedBox(height: 20),
                const Text(
                  'Cita Existente',
                  style: TextStyle(
                    fontSize: 20,
                    fontWeight: FontWeight.bold,
                    color: Color(0xFF333333),
                  ),
                ),
                const SizedBox(height: 12),
                Text(
                  'Ya tienes una cita programada en $specialty. Por favor, cancela tu cita actual antes de programar una nueva.',
                  textAlign: TextAlign.center,
                  style: TextStyle(
                    fontSize: 14,
                    color: Colors.grey[600],
                    height: 1.5,
                  ),
                ),
                const SizedBox(height: 24),
                SizedBox(
                  width: double.infinity,
                  height: 48,
                  child: ElevatedButton(
                    onPressed: () => Navigator.pop(context),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: const Color(0xFF7c4dff),
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                      elevation: 0,
                    ),
                    child: const Text(
                      'Entendido',
                      style: TextStyle(
                        fontSize: 16,
                        fontWeight: FontWeight.w600,
                        color: Colors.white,
                      ),
                    ),
                  ),
                ),
            ],
          ),
        ),
      ),
    );
    } else {
      Navigator.push(
        context,
        MaterialPageRoute(
          builder: (context) => AppointmentSelectionScreen(specialty: specialty),
        ),
      );
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Especialidades'),
      ),
      body: Column(
        children: [
          Padding(
            padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
            child: Container(
              height: 48,
              decoration: BoxDecoration(
                color: const Color(0xFFe7f1f3),
                borderRadius: BorderRadius.circular(12),
              ),
              child: Row(
                children: [
                  Padding(
                    padding: const EdgeInsets.only(left: 16),
                    child: Icon(
                      Icons.search,
                      color: const Color(0xFF4c8d9a),
                      size: 24,
                    ),
                  ),
                  Expanded(
                    child: Padding(
                      padding: const EdgeInsets.only(left: 8),
                      child: TextField(
                        controller: _searchController,
                        decoration: InputDecoration(
                          hintText: "Buscar especialidad",
                          hintStyle: TextStyle(
                            color: const Color(0xFF4c8d9a),
                          ),
                          border: InputBorder.none,
                          contentPadding: EdgeInsets.zero,
                        ),
                        style: TextStyle(
                          color: const Color(0xFF0d191b),
                          fontSize: 16,
                        ),
                        onChanged: _filterSpecialties,
                        onSubmitted: (value) {
                          _filterSpecialties(value);
                        },
                      ),
                    ),
                  ),
                  if (_searchController.text.isNotEmpty)
                    Padding(
                      padding: const EdgeInsets.only(right: 8),
                      child: GestureDetector(
                        onTap: _clearSearch,
                        child: Icon(
                          Icons.close,
                          color: const Color(0xFF4c8d9a),
                          size: 20,
                        ),
                      ),
                    ),
                ],
              ),
            ),
          ),

          Expanded(
            child: SingleChildScrollView(
              child: Padding(
                padding: const EdgeInsets.fromLTRB(16, 20, 16, 12),
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      "Servicios de Salud",
                      style: TextStyle(
                        color: const Color(0xFF0d191b),
                        fontSize: 22,
                        fontWeight: FontWeight.bold,
                        letterSpacing: -0.015,
                      ),
                    ),
                    const SizedBox(height: 6),
                    Container(
                      height: 3,
                      width: 60,
                      decoration: BoxDecoration(
                        color: const Color(0xFF7c4dff),
                        borderRadius: BorderRadius.circular(2),
                      ),
                    ),
                    const SizedBox(height: 16),
                    _filteredSpecialties.isEmpty
                        ? SizedBox(
                            height: 300,
                            child: Center(
                              child: Column(
                                mainAxisAlignment: MainAxisAlignment.center,
                                children: [
                                  Icon(
                                    Icons.search_off,
                                    color: const Color(0xFF4c8d9a),
                                    size: 50,
                                  ),
                                  const SizedBox(height: 16),
                                  Text(
                                    "No se encontraron especialidades",
                                    style: TextStyle(
                                      color: const Color(0xFF4c8d9a),
                                      fontSize: 16,
                                    ),
                                  ),
                                ],
                              ),
                            ),
                          )
                        : GridView.count(
                            shrinkWrap: true,
                            physics: const NeverScrollableScrollPhysics(),
                            crossAxisCount: 2,
                            crossAxisSpacing: 12,
                            mainAxisSpacing: 12,
                            childAspectRatio: 1,
                            children: _filteredSpecialties
                                .map((specialty) => GestureDetector(
                                      onTap: () => _navigateToAppointmentScreen(
                                          specialty["title"]!),
                                      child: _buildSpecialtyCard(
                                        specialty["title"]!,
                                        specialty["image"]!,
                                      ),
                                    ))
                                .toList(),
                          ),
                  ],
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildSpecialtyCard(String title, String imageUrl) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Expanded(
          child: Container(
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(12),
              image: DecorationImage(
                image: NetworkImage(imageUrl),
                fit: BoxFit.cover,
              ),
            ),
          ),
        ),
        const SizedBox(height: 8),
        Padding(
          padding: const EdgeInsets.only(left: 4),
          child: Text(
            title,
            style: TextStyle(
              color: const Color(0xFF0d191b),
              fontSize: 16,
              fontWeight: FontWeight.w500,
            ),
          ),
        ),
      ],
    );
  }
}

// ------------------------------------------------------------
// PANTALLA DE SELECCIÓN DE CITAS
// ------------------------------------------------------------
class AppointmentSelectionScreen extends StatefulWidget {
  final String specialty;
  
  const AppointmentSelectionScreen({super.key, required this.specialty});

  @override
  State<AppointmentSelectionScreen> createState() =>
      _AppointmentSelectionScreenState();
}

class _AppointmentSelectionScreenState
    extends State<AppointmentSelectionScreen> {
  int selectedDayIndex = 0;
  String selectedTime = '';
  bool isDaySelected = true;

  late List<Map<String, dynamic>> days;
  late List<Map<String, dynamic>> timeSlots;

  final List<String> weekdays = ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'];
  final List<String> monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];

  final Map<String, List<Map<String, String>>> doctorsBySpecialty = {
    'Cardiología': [
      {'name': 'Dr. Alberto Mendoza', 'image': 'https://lh3.googleusercontent.com/aida-public/AB6AXuDDHrn7MgHfLfYGfi-lNgp3Z7zey-v8R7ZsBXaWdAXYLzADiklLnMIQjateiOjacRDYbxUlCuTSH6mOSrXPVQP9IrXJ1SHFZJP8YxIfai30FYP9A-j1jUFxeuvgHQyuDLg9TCSvdnt7ACc_FhVirjt55bwROEnKUMvpiKc4csbYL2tOWkWdSOULSq2K_5c6y3IvovCn7SybTmKpuWHsW3d3jy5Yg6KQ_RfRK6RtSVKMgKpWKZICX_BACzoSl_B6Vj77Jtkd4OvfCuI'},
      {'name': 'Dra. Carmen Lozada', 'image': 'https://lh3.googleusercontent.com/aida-public/AB6AXuDi11-uaut76yYlow4PABwcHvgn8BU6mOn_REBaDMAr6EOcUFGMnoRTeoTRiMgK38-S0Y5jwspioKSH6peGgX1Q94OYYcsP_Mm98LsOH8rhZnQM6xvMF22h1QQ1Mg1cnqag8FaHIExZnsdcRFSSMJuVwtpldhLhrW6nJdmtXt8TI1kHZxyVOUwrrUnskQ2UsOzpBkuTG_OHrueykX9_PP90Ziydaw_StoN2v7JBjdrP2rpogLoG2_mM6EXiu6PbBZ9Kf8TMPyddEv8'},
      {'name': 'Dr. Roberto Huang', 'image': 'https://lh3.googleusercontent.com/aida-public/AB6AXuDDHrn7MgHfLfYGfi-lNgp3Z7zey-v8R7ZsBXaWdAXYLzADiklLnMIQjateiOjacRDYbxUlCuTSH6mOSrXPVQP9IrXJ1SHFZJP8YxIfai30FYP9A-j1jUFxeuvgHQyuDLg9TCSvdnt7ACc_FhVirjt55bwROEnKUMvpiKc4csbYL2tOWkWdSOULSq2K_5c6y3IvovCn7SybTmKpuWHsW3d3jy5Yg6KQ_RfRK6RtSVKMgKpWKZICX_BACzoSl_B6Vj77Jtkd4OvfCuI'},
    ],
    'Dermatología': [
      {'name': 'Dra. Ana María Vega', 'image': 'https://lh3.googleusercontent.com/aida-public/AB6AXuDi11-uaut76yYlow4PABwcHvgn8BU6mOn_REBaDMAr6EOcUFGMnoRTeoTRiMgK38-S0Y5jwspioKSH6peGgX1Q94OYYcsP_Mm98LsOH8rhZnQM6xvMF22h1QQ1Mg1cnqag8FaHIExZnsdcRFSSMJuVwtpldhLhrW6nJdmtXt8TI1kHZxyVOUwrrUnskQ2UsOzpBkuTG_OHrueykX9_PP90Ziydaw_StoN2v7JBjdrP2rpogLoG2_mM6EXiu6PbBZ9Kf8TMPyddEv8'},
      {'name': 'Dr. Carlos Mendoza', 'image': 'https://lh3.googleusercontent.com/aida-public/AB6AXuDDHrn7MgHfLfYGfi-lNgp3Z7zey-v8R7ZsBXaWdAXYLzADiklLnMIQjateiOjacRDYbxUlCuTSH6mOSrXPVQP9IrXJ1SHFZJP8YxIfai30FYP9A-j1jUFxeuvgHQyuDLg9TCSvdnt7ACc_FhVirjt55bwROEnKUMvpiKc4csbYL2tOWkWdSOULSq2K_5c6y3IvovCn7SybTmKpuWHsW3d3jy5Yg6KQ_RfRK6RtSVKMgKpWKZICX_BACzoSl_B6Vj77Jtkd4OvfCuI'},
      {'name': 'Dra. Lucía Pérez', 'image': 'https://lh3.googleusercontent.com/aida-public/AB6AXuDi11-uaut76yYlow4PABwcHvgn8BU6mOn_REBaDMAr6EOcUFGMnoRTeoTRiMgK38-S0Y5jwspioKSH6peGgX1Q94OYYcsP_Mm98LsOH8rhZnQM6xvMF22h1QQ1Mg1cnqag8FaHIExZnsdcRFSSMJuVwtpldhLhrW6nJdmtXt8TI1kHZxyVOUwrrUnskQ2UsOzpBkuTG_OHrueykX9_PP90Ziydaw_StoN2v7JBjdrP2rpogLoG2_mM6EXiu6PbBZ9Kf8TMPyddEv8'},
    ],
    'Gastroenterología': [
      {'name': 'Dr. Fernando Torres', 'image': 'https://lh3.googleusercontent.com/aida-public/AB6AXuDDHrn7MgHfLfYGfi-lNgp3Z7zey-v8R7ZsBXaWdAXYLzADiklLnMIQjateiOjacRDYbxUlCuTSH6mOSrXPVQP9IrXJ1SHFZJP8YxIfai30FYP9A-j1jUFxeuvgHQyuDLg9TCSvdnt7ACc_FhVirjt55bwROEnKUMvpiKc4csbYL2tOWkWdSOULSq2K_5c6y3IvovCn7SybTmKpuWHsW3d3jy5Yg6KQ_RfRK6RtSVKMgKpWKZICX_BACzoSl_B6Vj77Jtkd4OvfCuI'},
      {'name': 'Dra. Sandra Flores', 'image': 'https://lh3.googleusercontent.com/aida-public/AB6AXuDi11-uaut76yYlow4PABwcHvgn8BU6mOn_REBaDMAr6EOcUFGMnoRTeoTRiMgK38-S0Y5jwspioKSH6peGgX1Q94OYYcsP_Mm98LsOH8rhZnQM6xvMF22h1QQ1Mg1cnqag8FaHIExZnsdcRFSSMJuVwtpldhLhrW6nJdmtXt8TI1kHZxyVOUwrrUnskQ2UsOzpBkuTG_OHrueykX9_PP90Ziydaw_StoN2v7JBjdrP2rpogLoG2_mM6EXiu6PbBZ9Kf8TMPyddEv8'},
      {'name': 'Dr. Jorge Díaz', 'image': 'https://lh3.googleusercontent.com/aida-public/AB6AXuDDHrn7MgHfLfYGfi-lNgp3Z7zey-v8R7ZsBXaWdAXYLzADiklLnMIQjateiOjacRDYbxUlCuTSH6mOSrXPVQP9IrXJ1SHFZJP8YxIfai30FYP9A-j1jUFxeuvgHQyuDLg9TCSvdnt7ACc_FhVirjt55bwROEnKUMvpiKc4csbYL2tOWkWdSOULSq2K_5c6y3IvovCn7SybTmKpuWHsW3d3jy5Yg6KQ_RfRK6RtSVKMgKpWKZICX_BACzoSl_B6Vj77Jtkd4OvfCuI'},
    ],
    'Neurología': [
      {'name': 'Dra. María Elena Sosa', 'image': 'https://lh3.googleusercontent.com/aida-public/AB6AXuDi11-uaut76yYlow4PABwcHvgn8BU6mOn_REBaDMAr6EOcUFGMnoRTeoTRiMgK38-S0Y5jwspioKSH6peGgX1Q94OYYcsP_Mm98LsOH8rhZnQM6xvMF22h1QQ1Mg1cnqag8FaHIExZnsdcRFSSMJuVwtpldhLhrW6nJdmtXt8TI1kHZxyVOUwrrUnskQ2UsOzpBkuTG_OHrueykX9_PP90Ziydaw_StoN2v7JBjdrP2rpogLoG2_mM6EXiu6PbBZ9Kf8TMPyddEv8'},
      {'name': 'Dr. Pablo Aguilar', 'image': 'https://lh3.googleusercontent.com/aida-public/AB6AXuDDHrn7MgHfLfYGfi-lNgp3Z7zey-v8R7ZsBXaWdAXYLzADiklLnMIQjateiOjacRDYbxUlCuTSH6mOSrXPVQP9IrXJ1SHFZJP8YxIfai30FYP9A-j1jUFxeuvgHQyuDLg9TCSvdnt7ACc_FhVirjt55bwROEnKUMvpiKc4csbYL2tOWkWdSOULSq2K_5c6y3IvovCn7SybTmKpuWHsW3d3jy5Yg6KQ_RfRK6RtSVKMgKpWKZICX_BACzoSl_B6Vj77Jtkd4OvfCuI'},
      {'name': 'Dra. Carolina Ruiz', 'image': 'https://lh3.googleusercontent.com/aida-public/AB6AXuDi11-uaut76yYlow4PABwcHvgn8BU6mOn_REBaDMAr6EOcUFGMnoRTeoTRiMgK38-S0Y5jwspioKSH6peGgX1Q94OYYcsP_Mm98LsOH8rhZnQM6xvMF22h1QQ1Mg1cnqag8FaHIExZnsdcRFSSMJuVwtpldhLhrW6nJdmtXt8TI1kHZxyVOUwrrUnskQ2UsOzpBkuTG_OHrueykX9_PP90Ziydaw_StoN2v7JBjdrP2rpogLoG2_mM6EXiu6PbBZ9Kf8TMPyddEv8'},
    ],
    'Oftalmología': [
      {'name': 'Dr. José Luis Quiroz', 'image': 'https://lh3.googleusercontent.com/aida-public/AB6AXuDDHrn7MgHfLfYGfi-lNgp3Z7zey-v8R7ZsBXaWdAXYLzADiklLnMIQjateiOjacRDYbxUlCuTSH6mOSrXPVQP9IrXJ1SHFZJP8YxIfai30FYP9A-j1jUFxeuvgHQyuDLg9TCSvdnt7ACc_FhVirjt55bwROEnKUMvpiKc4csbYL2tOWkWdSOULSq2K_5c6y3IvovCn7SybTmKpuWHsW3d3jy5Yg6KQ_RfRK6RtSVKMgKpWKZICX_BACzoSl_B6Vj77Jtkd4OvfCuI'},
      {'name': 'Dra. Roxana Meza', 'image': 'https://lh3.googleusercontent.com/aida-public/AB6AXuDi11-uaut76yYlow4PABwcHvgn8BU6mOn_REBaDMAr6EOcUFGMnoRTeoTRiMgK38-S0Y5jwspioKSH6peGgX1Q94OYYcsP_Mm98LsOH8rhZnQM6xvMF22h1QQ1Mg1cnqag8FaHIExZnsdcRFSSMJuVwtpldhLhrW6nJdmtXt8TI1kHZxyVOUwrrUnskQ2UsOzpBkuTG_OHrueykX9_PP90Ziydaw_StoN2v7JBjdrP2rpogLoG2_mM6EXiu6PbBZ9Kf8TMPyddEv8'},
      {'name': 'Dr. Marco Astoquillca', 'image': 'https://lh3.googleusercontent.com/aida-public/AB6AXuDDHrn7MgHfLfYGfi-lNgp3Z7zey-v8R7ZsBXaWdAXYLzADiklLnMIQjateiOjacRDYbxUlCuTSH6mOSrXPVQP9IrXJ1SHFZJP8YxIfai30FYP9A-j1jUFxeuvgHQyuDLg9TCSvdnt7ACc_FhVirjt55bwROEnKUMvpiKc4csbYL2tOWkWdSOULSq2K_5c6y3IvovCn7SybTmKpuWHsW3d3jy5Yg6KQ_RfRK6RtSVKMgKpWKZICX_BACzoSl_B6Vj77Jtkd4OvfCuI'},
    ],
    'Pediatría': [
      {'name': 'Dra. Giuliana Alva', 'image': 'https://lh3.googleusercontent.com/aida-public/AB6AXuDi11-uaut76yYlow4PABwcHvgn8BU6mOn_REBaDMAr6EOcUFGMnoRTeoTRiMgK38-S0Y5jwspioKSH6peGgX1Q94OYYcsP_Mm98LsOH8rhZnQM6xvMF22h1QQ1Mg1cnqag8FaHIExZnsdcRFSSMJuVwtpldhLhrW6nJdmtXt8TI1kHZxyVOUwrrUnskQ2UsOzpBkuTG_OHrueykX9_PP90Ziydaw_StoN2v7JBjdrP2rpogLoG2_mM6EXiu6PbBZ9Kf8TMPyddEv8'},
      {'name': 'Dr. Wilder Shccara', 'image': 'https://lh3.googleusercontent.com/aida-public/AB6AXuDDHrn7MgHfLfYGfi-lNgp3Z7zey-v8R7ZsBXaWdAXYLzADiklLnMIQjateiOjacRDYbxUlCuTSH6mOSrXPVQP9IrXJ1SHFZJP8YxIfai30FYP9A-j1jUFxeuvgHQyuDLg9TCSvdnt7ACc_FhVirjt55bwROEnKUMvpiKc4csbYL2tOWkWdSOULSq2K_5c6y3IvovCn7SybTmKpuWHsW3d3jy5Yg6KQ_RfRK6RtSVKMgKpWKZICX_BACzoSl_B6Vj77Jtkd4OvfCuI'},
      {'name': 'Dra. Lily Vega', 'image': 'https://lh3.googleusercontent.com/aida-public/AB6AXuDi11-uaut76yYlow4PABwcHvgn8BU6mOn_REBaDMAr6EOcUFGMnoRTeoTRiMgK38-S0Y5jwspioKSH6peGgX1Q94OYYcsP_Mm98LsOH8rhZnQM6xvMF22h1QQ1Mg1cnqag8FaHIExZnsdcRFSSMJuVwtpldhLhrW6nJdmtXt8TI1kHZxyVOUwrrUnskQ2UsOzpBkuTG_OHrueykX9_PP90Ziydaw_StoN2v7JBjdrP2rpogLoG2_mM6EXiu6PbBZ9Kf8TMPyddEv8'},
    ],
  };

  List<Map<String, String>> _getDoctorsForSpecialty() {
    return doctorsBySpecialty[widget.specialty] ?? [
      {'name': 'Dr. Juan Pérez', 'image': 'https://lh3.googleusercontent.com/aida-public/AB6AXuDDHrn7MgHfLfYGfi-lNgp3Z7zey-v8R7ZsBXaWdAXYLzADiklLnMIQjateiOjacRDYbxUlCuTSH6mOSrXPVQP9IrXJ1SHFZJP8YxIfai30FYP9A-j1jUFxeuvgHQyuDLg9TCSvdnt7ACc_FhVirjt55bwROEnKUMvpiKc4csbYL2tOWkWdSOULSq2K_5c6y3IvovCn7SybTmKpuWHsW3d3jy5Yg6KQ_RfRK6RtSVKMgKpWKZICX_BACzoSl_B6Vj77Jtkd4OvfCuI'},
      {'name': 'Dra. María López', 'image': 'https://lh3.googleusercontent.com/aida-public/AB6AXuDi11-uaut76yYlow4PABwcHvgn8BU6mOn_REBaDMAr6EOcUFGMnoRTeoTRiMgK38-S0Y5jwspioKSH6peGgX1Q94OYYcsP_Mm98LsOH8rhZnQM6xvMF22h1QQ1Mg1cnqag8FaHIExZnsdcRFSSMJuVwtpldhLhrW6nJdmtXt8TI1kHZxyVOUwrrUnskQ2UsOzpBkuTG_OHrueykX9_PP90Ziydaw_StoN2v7JBjdrP2rpogLoG2_mM6EXiu6PbBZ9Kf8TMPyddEv8'},
      {'name': 'Dr. Carlos Ruiz', 'image': 'https://lh3.googleusercontent.com/aida-public/AB6AXuDDHrn7MgHfLfYGfi-lNgp3Z7zey-v8R7ZsBXaWdAXYLzADiklLnMIQjateiOjacRDYbxUlCuTSH6mOSrXPVQP9IrXJ1SHFZJP8YxIfai30FYP9A-j1jUFxeuvgHQyuDLg9TCSvdnt7ACc_FhVirjt55bwROEnKUMvpiKc4csbYL2tOWkWdSOULSq2K_5c6y3IvovCn7SybTmKpuWHsW3d3jy5Yg6KQ_RfRK6RtSVKMgKpWKZICX_BACzoSl_B6Vj77Jtkd4OvfCuI'},
    ];
  }

  @override
  void initState() {
    super.initState();
    days = _generateDaysOfFebruary2026();
    timeSlots = generateTimeSlots();
  }

  List<Map<String, dynamic>> _generateDaysOfFebruary2026() {
    List<Map<String, dynamic>> daysList = [];
    final doctors = _getDoctorsForSpecialty();
    
    DateTime firstDay = DateTime(2026, 2, 1);
    
    for (int i = 0; i < 28; i++) {
      DateTime currentDay = firstDay.add(Duration(days: i));
      int weekdayIndex = currentDay.weekday - 1;
      String weekday = weekdays[weekdayIndex];
      
      bool isWeekend = weekdayIndex >= 5;
      
      final doctorIndex = i % doctors.length;
      String doctorName = doctors[doctorIndex]['name']!;
      String? imageUrl = doctors[doctorIndex]['image'];
      
      daysList.add({
        'day': currentDay.day.toString(),
        'weekday': weekday,
        'month': 'Febrero',
        'doctorName': isWeekend ? 'Libre' : doctorName,
        'imageUrl': isWeekend ? null : imageUrl,
        'isFree': isWeekend,
        'available': !isWeekend,
        'fullDate': '${currentDay.day} de Febrero',
      });
    }
    
    return daysList;
  }

  List<Map<String, dynamic>> generateTimeSlots() {
    List<Map<String, dynamic>> slots = [];

    for (int hour = 7; hour <= 12; hour++) {
      int maxMinute = (hour == 12) ? 0 : 60;
      
      for (int minute = 0; minute < maxMinute; minute += 15) {
        final time =
            '${hour.toString().padLeft(2, '0')}:${minute.toString().padLeft(2, '0')}';

        slots.add({
          'time': time,
          'duration': '15 min',
          'available': true,
          'selected': time == selectedTime,
          'isMorning': true,
        });
      }
    }

    for (int hour = 14; hour <= 17; hour++) {
      int startMinute = (hour == 14) ? 30 : 0;
      int maxMinute = (hour == 17) ? 0 : 60;
      
      for (int minute = startMinute; minute < maxMinute; minute += 15) {
        if (hour == 17 && minute > 0) break;
        
        final time =
            '${hour.toString().padLeft(2, '0')}:${minute.toString().padLeft(2, '0')}';

        slots.add({
          'time': time,
          'duration': '15 min',
          'available': true,
          'selected': time == selectedTime,
          'isMorning': false,
        });
      }
    }

    return slots;
  }

  bool _isTimeSlotBooked(String time) {
    final appointments = AppointmentsManager().appointments;
    final selectedDay = days[selectedDayIndex];
    
    for (var appointment in appointments) {
      if (appointment['specialty'] == widget.specialty &&
          appointment['date'] == selectedDay['fullDate'] &&
          appointment['time'] == time) {
        return true;
      }
    }
    return false;
  }

  void selectDay(int index) {
    setState(() {
      selectedDayIndex = index;
      final dayAvailable = days[index]['available'] as bool? ?? false;
      isDaySelected = dayAvailable;

      selectedTime = '';
      timeSlots = generateTimeSlots();
    });
  }

  void selectTime(String time) {
    final dayAvailable = days[selectedDayIndex]['available'] as bool? ?? false;
    if (!dayAvailable) {
      return;
    }

    if (_isTimeSlotBooked(time)) {
      return;
    }

    setState(() {
      selectedTime = time;

      for (var slot in timeSlots) {
        slot['selected'] = slot['time'] == time;
      }
    });
  }

  void bookAppointment() {
    if (!isDaySelected) {
      showDialog(
        context: context,
        builder: (context) => AlertDialog(
          title: const Text('Día no disponible'),
          content: const Text(
              'El día seleccionado no tiene disponibilidad. Por favor selecciona otro día.'),
          actions: [
            TextButton(
              onPressed: () => Navigator.pop(context),
              child: const Text('OK'),
            ),
          ],
        ),
      );
      return;
    }

    if (selectedTime.isEmpty) {
      showDialog(
        context: context,
        builder: (context) => AlertDialog(
          title: const Text('Horario no seleccionado'),
          content: const Text(
              'Por favor, selecciona un horario disponible.'),
          actions: [
            TextButton(
              onPressed: () => Navigator.pop(context),
              child: const Text('OK'),
            ),
          ],
        ),
      );
      return;
    }

    final selectedDay = days[selectedDayIndex];

    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => CitaConfirmadaScreen(
          specialty: widget.specialty,
          doctorName: selectedDay['doctorName'] as String,
          date: selectedDay['fullDate'] as String,
          time: selectedTime,
          duration: '15 minutos',
        ),
      ),
    );
  }

@override
  Widget build(BuildContext context) {
    final selectedDay = days[selectedDayIndex];
    
    final bookedTimes = <String>{};
    final appointments = AppointmentsManager().appointments;
    final dayFullDate = selectedDay['fullDate'] as String;
    for (var appointment in appointments) {
      if (appointment['specialty'] == widget.specialty &&
          appointment['date'] == dayFullDate) {
        bookedTimes.add(appointment['time'] as String);
      }
    }
    
    final availableSlots = timeSlots.where((slot) => 
      (slot['available'] as bool) && !bookedTimes.contains(slot['time'])
    ).length;
    final totalSlots = timeSlots.length;
    final dayAvailable = selectedDay['available'] as bool? ?? false;

    final morningSlots =
        timeSlots.where((slot) => slot['isMorning'] as bool).toList();
    final afternoonSlots =
        timeSlots.where((slot) => !(slot['isMorning'] as bool)).toList();

    return Scaffold(
      appBar: AppBar(
        leading: IconButton(
          icon: const Icon(Icons.arrow_back, color: Color(0xFF333333)),
          onPressed: () => Navigator.pop(context),
        ),
        title: Text('${widget.specialty} - Turnos'),
      ),
      body: Column(
        children: [
          Expanded(
            child: SingleChildScrollView(
              padding: const EdgeInsets.only(bottom: 10),
              child: Column(
                children: [
                  Padding(
                    padding: const EdgeInsets.symmetric(horizontal: 16),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Row(
                          mainAxisAlignment: MainAxisAlignment.spaceBetween,
                          children: [
                            const Text(
                              'Médico por día',
                              style: TextStyle(
                                color: Color(0xFF0d1b1a),
                                fontSize: 18,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
Text(
                              'Febrero 2026',
                              style: TextStyle(
                                color: const Color(0xFF7c4dff),
                                fontSize: 14,
                                fontWeight: FontWeight.w500,
                              ),
                            ),
                          ],
                        ),
                        const SizedBox(height: 12),
                        SizedBox(
                          height: 140,
                          child: ListView(
                            scrollDirection: Axis.horizontal,
                            shrinkWrap: true,
                            children: List.generate(days.length, (index) {
                              final day = days[index];
                              return GestureDetector(
                                onTap: () => selectDay(index),
                                child: _buildDayCard(
                                  day: day['day'] as String,
                                  weekday: day['weekday'] as String,
                                  doctorName: day['doctorName'] as String,
                                  imageUrl: day['imageUrl'] as String?,
                                  isSelected: index == selectedDayIndex,
                                  isFree: day['isFree'] as bool? ?? false,
                                  available: day['available'] as bool? ?? false,
                                ),
                              );
                            }),
                          ),
                        ),
                        if (!dayAvailable)
                          Padding(
                            padding: const EdgeInsets.only(top: 4, left: 4),
                            child: Row(
                              children: [
                                Icon(Icons.info_outline,
                                    color: Colors.orange[700], size: 16),
                                const SizedBox(width: 6),
                                Text(
                                  'Este día no tiene disponibilidad',
                                  style: TextStyle(
                                    color: Colors.orange[700],
                                    fontSize: 12,
                                    fontStyle: FontStyle.italic,
                                  ),
                                ),
                              ],
                            ),
                          ),
                      ],
                    ),
                  ),

                  Padding(
                    padding: const EdgeInsets.fromLTRB(16, 12, 16, 12),
                    child: Container(
                      decoration: BoxDecoration(
                        gradient: const LinearGradient(
                          begin: Alignment.topLeft,
                          end: Alignment.bottomRight,
                          colors: [
                            Color(0xFF7c4dff),
                            Color(0xFF9c27b0),
                          ],
                        ),
                        borderRadius: BorderRadius.circular(20),
                        boxShadow: [
                          BoxShadow(
                            color: Colors.purple.withValues(alpha: 0.2),
                            blurRadius: 8,
                            offset: const Offset(0, 4),
                          ),
                        ],
                      ),
                      padding: const EdgeInsets.all(16),
                      child: Row(
                        children: [
                          Stack(
                            clipBehavior: Clip.none,
                            children: [
                              Container(
                                width: 60,
                                height: 60,
                                decoration: BoxDecoration(
                                  borderRadius: BorderRadius.circular(12),
                                  border: Border.all(
                                    color: Colors.white.withValues(alpha: 0.3),
                                    width: 2,
                                  ),
                                  image: selectedDay['imageUrl'] != null
                                      ? DecorationImage(
                                          image: NetworkImage(
                                            selectedDay['imageUrl'] as String,
                                          ),
                                          fit: BoxFit.cover,
                                        )
                                      : null,
                                  color: selectedDay['imageUrl'] == null
                                      ? Colors.white.withValues(alpha: 0.3)
                                      : null,
                                ),
                                child: selectedDay['imageUrl'] == null
                                    ? const Icon(
                                        Icons.person,
                                        color: Colors.white,
                                        size: 30,
                                      )
                                    : null,
                              ),
                              if (!(selectedDay['isFree'] as bool? ?? true))
                                Positioned(
                                  bottom: -4,
                                  right: -4,
                                  child: Container(
                                    width: 20,
                                    height: 20,
                                    decoration: BoxDecoration(
                                      color: const Color(0xFF13ecda),
                                      borderRadius: BorderRadius.circular(10),
                                      border: Border.all(
                                        color: Colors.white,
                                        width: 2,
                                      ),
                                    ),
                                    child: const Icon(
                                      Icons.verified,
                                      size: 10,
                                      color: Colors.black,
                                    ),
                                  ),
                                ),
                            ],
                          ),
                          const SizedBox(width: 12),
                          Expanded(
                            child: Column(
                              crossAxisAlignment: CrossAxisAlignment.start,
                              children: [
                                Text(
                                  'MÉDICO DE TURNO',
                                  style: TextStyle(
                                    color: Colors.white.withValues(alpha: 0.8),
                                    fontSize: 10,
                                    fontWeight: FontWeight.bold,
                                    letterSpacing: 1.2,
                                  ),
                                ),
                                const SizedBox(height: 2),
                                Text(
                                  selectedDay['doctorName'] as String,
                                  style: const TextStyle(
                                    color: Colors.white,
                                    fontSize: 16,
                                    fontWeight: FontWeight.bold,
                                  ),
                                  maxLines: 1,
                                  overflow: TextOverflow.ellipsis,
                                ),
                                const SizedBox(height: 2),
                                Text(
                                  dayAvailable
                                      ? 'Especialista en ${widget.specialty}'
                                      : 'Sin disponibilidad',
                                  style: TextStyle(
                                    color: Colors.white.withValues(alpha: 0.9),
                                    fontSize: 12,
                                  ),
                                  maxLines: 1,
                                  overflow: TextOverflow.ellipsis,
                                ),
                              ],
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),

                  Padding(
                    padding: const EdgeInsets.symmetric(horizontal: 16),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Row(
                          mainAxisAlignment: MainAxisAlignment.spaceBetween,
                          children: [
                            const Text(
                              'Bloques Disponibles',
                              style: TextStyle(
                                color: Color(0xFF0d1b1a),
                                fontSize: 18,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                            Container(
                              padding: const EdgeInsets.symmetric(
                                horizontal: 12,
                                vertical: 6,
                              ),
                              decoration: BoxDecoration(
                                color:
                                    const Color(0xFF13ecda).withValues(alpha: 0.1),
                                borderRadius: BorderRadius.circular(16),
                              ),
                              child: Row(
                                mainAxisSize: MainAxisSize.min,
                                children: [
                                  const Icon(
                                    Icons.event_available,
                                    size: 14,
                                    color: Color(0xFF0f8e83),
                                  ),
                                  const SizedBox(width: 4),
                                  Text(
                                    dayAvailable
                                        ? '$availableSlots de $totalSlots libres'
                                        : '0 de 0 libres',
                                    style: TextStyle(
                                      color: const Color(0xFF0f8e83),
                                      fontSize: 11,
                                      fontWeight: FontWeight.bold,
                                    ),
                                  ),
                                ],
                              ),
                            ),
                          ],
                        ),
                        const SizedBox(height: 12),

                        Padding(
                          padding: const EdgeInsets.only(bottom: 8, top: 4),
                          child: Text(
                            dayAvailable
                                ? 'Horarios disponibles:'
                                : 'No hay horarios disponibles para este día',
                            style: TextStyle(
                              color: dayAvailable
                                  ? const Color(0xFF666666)
                                  : Colors.orange[700],
                              fontSize: 12,
                            ),
                          ),
                        ),

                        if (dayAvailable)
                          Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Padding(
                                padding: const EdgeInsets.only(bottom: 8, top: 4),
                                child: Text(
                                  'Mañana (7:00 AM - 12:00 PM)',
                                  style: TextStyle(
                                    color: const Color(0xFF7c4dff),
                                    fontSize: 13,
                                    fontWeight: FontWeight.w600,
                                  ),
                                ),
                              ),
                              GridView.builder(
                                shrinkWrap: true,
                                physics: const NeverScrollableScrollPhysics(),
                                gridDelegate:
                                    const SliverGridDelegateWithFixedCrossAxisCount(
                                  crossAxisCount: 3,
                                  crossAxisSpacing: 8,
                                  mainAxisSpacing: 8,
                                  childAspectRatio: 1.3,
                                ),
itemCount: morningSlots.length,
                                itemBuilder: (context, index) {
                                  final slot = morningSlots[index];
                                  final slotAvailable = slot['available'] as bool;
                                  final isBooked = bookedTimes.contains(slot['time']);

                                  return GestureDetector(
                                    onTap: slotAvailable && dayAvailable && !isBooked
                                        ? () => selectTime(slot['time'] as String)
                                        : null,
                                    child: _buildTimeSlot(
                                      slot['time'] as String,
                                      slot['duration'] as String,
                                      isAvailable: slotAvailable && !isBooked,
                                      isSelected: slot['selected'] as bool? ?? false,
                                      dayAvailable: dayAvailable,
                                    ),
                                  );
                                },
                              ),
                            ],
                          ),

                        if (dayAvailable)
                          Column(
                            crossAxisAlignment: CrossAxisAlignment.start,
                            children: [
                              Padding(
                                padding: const EdgeInsets.only(bottom: 8, top: 12),
                                child: Text(
                                  'Tarde (2:30 PM - 5:00 PM)',
                                  style: TextStyle(
                                    color: const Color(0xFF7c4dff),
                                    fontSize: 13,
                                    fontWeight: FontWeight.w600,
                                  ),
                                ),
                              ),
                              GridView.builder(
                                shrinkWrap: true,
                                physics: const NeverScrollableScrollPhysics(),
                                gridDelegate:
                                    const SliverGridDelegateWithFixedCrossAxisCount(
                                  crossAxisCount: 3,
                                  crossAxisSpacing: 8,
                                  mainAxisSpacing: 8,
                                  childAspectRatio: 1.3,
                                ),
itemCount: afternoonSlots.length,
                                itemBuilder: (context, index) {
                                  final slot = afternoonSlots[index];
                                  final slotAvailable = slot['available'] as bool;
                                  final isBooked = bookedTimes.contains(slot['time']);

                                  return GestureDetector(
                                    onTap: slotAvailable && dayAvailable && !isBooked
                                        ? () => selectTime(slot['time'] as String)
                                        : null,
                                    child: _buildTimeSlot(
                                      slot['time'] as String,
                                      slot['duration'] as String,
                                      isAvailable: slotAvailable && !isBooked,
                                      isSelected: slot['selected'] as bool? ?? false,
                                      dayAvailable: dayAvailable,
                                    ),
                                  );
                                },
                              ),
                            ],
                          ),

                        const SizedBox(height: 8),
                      ],
                    ),
                  ),
                ],
              ),
            ),
          ),

          Container(
            decoration: BoxDecoration(
              color: Colors.white,
              border: Border(
                top: BorderSide(
                  color: const Color(0xFFe5e7eb),
                  width: 1,
                ),
              ),
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withValues(alpha: 0.1),
                  blurRadius: 8,
                  offset: const Offset(0, -2),
                ),
              ],
            ),
            padding: const EdgeInsets.fromLTRB(16, 10, 16, 12),
            child: Column(
              children: [
                Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          'CITA PROGRAMADA',
                          style: TextStyle(
                            color: const Color(0xFF9ca3af),
                            fontSize: 9,
                            fontWeight: FontWeight.bold,
                            letterSpacing: 1,
                          ),
                        ),
                        const SizedBox(height: 2),
                        Text(
                          dayAvailable && selectedTime.isNotEmpty
                              ? '${selectedDay['day']} de Agosto, $selectedTime'
                              : 'Sin cita seleccionada',
                          style: TextStyle(
                            color: dayAvailable && selectedTime.isNotEmpty
                                ? const Color(0xFF0d1b1a)
                                : const Color(0xFF9ca3af),
                            fontSize: 13,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                      ],
                    ),
                    Container(
                      padding: const EdgeInsets.all(6),
                      decoration: BoxDecoration(
                        color: const Color(0xFFf3e5f5),
                        borderRadius: BorderRadius.circular(10),
                        border: Border.all(
                          color: const Color(0xFF7c4dff).withValues(alpha: 0.3),
                          width: 1,
                        ),
                      ),
                      child: const Icon(
                        Icons.medical_services_outlined,
                        color: Color(0xFF7c4dff),
                        size: 18,
                      ),
                    ),
                  ],
                ),
                const SizedBox(height: 10),
                SizedBox(
                  width: double.infinity,
                  height: 46,
                  child: ElevatedButton(
                    onPressed: isDaySelected && selectedTime.isNotEmpty
                        ? bookAppointment
                        : null,
                    style: ElevatedButton.styleFrom(
                      backgroundColor: isDaySelected && selectedTime.isNotEmpty
                          ? const Color(0xFF7c4dff)
                          : Colors.grey[400],
                      foregroundColor: Colors.white,
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(12),
                      ),
                      elevation: 2,
                    ),
                    child: Row(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Text(
                          isDaySelected && selectedTime.isNotEmpty
                              ? 'Confirmar'
                              : 'Selecciona día y hora',
                          style: const TextStyle(
                            fontSize: 14,
                            fontWeight: FontWeight.w700,
                          ),
                        ),
                        if (isDaySelected && selectedTime.isNotEmpty)
                          const SizedBox(width: 6),
                        if (isDaySelected && selectedTime.isNotEmpty)
                          const Icon(Icons.check_circle, size: 16),
                      ],
                    ),
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildDayCard({
    required String day,
    required String weekday,
    required String doctorName,
    String? imageUrl,
    bool isSelected = false,
    bool isFree = false,
    required bool available,
  }) {
    return Container(
      width: 76,
      margin: const EdgeInsets.only(right: 8),
      padding: const EdgeInsets.all(8),
      decoration: BoxDecoration(
        color: isSelected
            ? (available ? const Color(0xFF7c4dff) : Colors.grey[400])
            : Colors.white,
        borderRadius: BorderRadius.circular(12),
        border: Border.all(
          color: isSelected ? Colors.transparent : const Color(0xFFe5e7eb),
          width: 1,
        ),
        boxShadow: [
          BoxShadow(
            color: isSelected 
                ? Colors.black.withValues(alpha: 0.1) 
                : Colors.black.withValues(alpha: 0.05),
            blurRadius: 4,
            offset: const Offset(0, 2),
          ),
        ],
      ),
      child: Column(
        mainAxisAlignment: MainAxisAlignment.center,
        children: [
          Text(
            weekday,
            style: TextStyle(
              color: isSelected
                  ? Colors.white.withValues(alpha: 0.8)
                  : const Color(0xFF9ca3af),
              fontSize: 11,
              fontWeight: FontWeight.w500,
            ),
          ),
          const SizedBox(height: 4),
          Text(
            day,
            style: TextStyle(
              color: isSelected ? Colors.white : const Color(0xFF0d1b1a),
              fontSize: 18,
              fontWeight: FontWeight.bold,
            ),
          ),
          const SizedBox(height: 6),
          Column(
            children: [
              if (isFree || !available)
                Container(
                  width: 32,
                  height: 32,
                  decoration: BoxDecoration(
                    color: const Color(0xFFe5e7eb),
                    borderRadius: BorderRadius.circular(16),
                  ),
                  child: const Icon(
                    Icons.block,
                    size: 14,
                    color: Color(0xFF9ca3af),
                  ),
                )
              else if (imageUrl != null)
                Container(
                  width: 32,
                  height: 32,
                  decoration: BoxDecoration(
                    borderRadius: BorderRadius.circular(16),
                    border: Border.all(
                      color: isSelected
                          ? Colors.white.withValues(alpha: 0.5)
                          : const Color(0xFFe5e7eb),
                      width: isSelected ? 2 : 1,
                    ),
                    image: DecorationImage(
                      image: NetworkImage(imageUrl),
                      fit: BoxFit.cover,
                    ),
                  ),
                ),
              const SizedBox(height: 4),
              Text(
                doctorName,
                textAlign: TextAlign.center,
                style: TextStyle(
                  color: isSelected ? Colors.white : const Color(0xFF6b7280),
                  fontSize: 9,
                  fontWeight: FontWeight.w500,
                  height: 1.2,
                ),
                maxLines: 2,
                overflow: TextOverflow.ellipsis,
              ),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildTimeSlot(
    String time,
    String duration, {
    bool isAvailable = true,
    bool isSelected = false,
    bool dayAvailable = true,
  }) {
    return Container(
      decoration: BoxDecoration(
        color: dayAvailable
            ? (isAvailable
                ? (isSelected
                    ? const Color(0xFF7c4dff).withValues(alpha: 0.1)
                    : Colors.white)
                : const Color(0xFFf3f4f6).withValues(alpha: 0.5))
            : const Color(0xFFf3f4f6).withValues(alpha: 0.5),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(
          color: isSelected
              ? const Color(0xFF7c4dff)
              : (isAvailable && dayAvailable
                  ? const Color(0xFFe5e7eb)
                  : Colors.transparent),
          width: isSelected ? 2 : 1,
        ),
      ),
      child: Center(
        child: Padding(
          padding: const EdgeInsets.symmetric(vertical: 6),
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Text(
                time,
                style: TextStyle(
                  color: dayAvailable
                      ? (isAvailable
                          ? (isSelected
                              ? const Color(0xFF7c4dff)
                              : const Color(0xFF0d1b1a))
                          : const Color(0xFF9ca3af))
                      : const Color(0xFF9ca3af),
                  fontSize: 14,
                  fontWeight: FontWeight.bold,
                ),
              ),
              
              Text(
                '15 min',
                style: TextStyle(
                  color: dayAvailable
                      ? (isAvailable
                          ? (isSelected
                              ? const Color(0xFF7c4dff)
                              : const Color(0xFF9ca3af))
                          : const Color(0xFF9ca3af))
                      : const Color(0xFF9ca3af),
                  fontSize: 10,
                  fontWeight: FontWeight.w500,
                ),
              ),
              
              if (isSelected && dayAvailable) 
                Padding(
                  padding: const EdgeInsets.only(top: 2),
                  child: Container(
                    padding: const EdgeInsets.symmetric(horizontal: 6, vertical: 1),
                    decoration: BoxDecoration(
                      color: const Color(0xFF7c4dff),
                      borderRadius: BorderRadius.circular(8),
                    ),
                    child: const Text(
                      'SELECCIONADO',
                      style: TextStyle(
                        color: Colors.white,
                        fontSize: 7,
                        fontWeight: FontWeight.bold,
                        letterSpacing: 0.5,
                      ),
                    ),
                  ),
                ),
            ],
          ),
        ),
      ),
    );
  }
}

// ------------------------------------------------------------
// PANTALLA DE CITA CONFIRMADA
// ------------------------------------------------------------
class CitaConfirmadaScreen extends StatelessWidget {
  final String specialty;
  final String doctorName;
  final String date;
  final String time;
  final String duration;

  const CitaConfirmadaScreen({
    super.key,
    required this.specialty,
    required this.doctorName,
    required this.date,
    required this.time,
    required this.duration,
  });

  // Función para formatear la fecha en formato "Lun, 24 Oct"
  String _formatDate(String date) {
    try {
      final parts = date.split(' de ');
      if (parts.isNotEmpty) {
        final day = parts[0].trim();
        
        final now = DateTime.now();
        final monthStr = parts.length > 1 ? parts[1].trim() : now.month.toString();
        
        final monthMap = {
          'Enero': 1, 'Febrero': 2, 'Marzo': 3, 'Abril': 4,
          'Mayo': 5, 'Junio': 6, 'Julio': 7, 'Agosto': 8,
          'Septiembre': 9, 'Octubre': 10, 'Noviembre': 11, 'Diciembre': 12
        };
        
        final month = monthMap[monthStr] ?? now.month;
        final year = now.year;
        
        final parsedDate = DateTime(year, month, int.parse(day));
        
        final weekday = _getWeekdayAbbreviation(parsedDate.weekday);
        final monthAbbrev = _getMonthAbbreviation(month);
        
        return '$weekday, $day $monthAbbrev';
      }
    } catch (e) {
      // print('Error formateando fecha: $e');
    }
    return date;
  }

  String _getWeekdayAbbreviation(int weekday) {
    const weekdays = ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'];
    return weekdays[weekday % 7];
  }

  String _getMonthAbbreviation(int month) {
    const months = [
      'Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun',
      'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'
    ];
    return months[month - 1];
  }

  // Función para formatear la hora en formato "10:15 AM" o "10:15 PM"
  String _formatTime(String time) {
    try {
      final parts = time.split(':');
      if (parts.length >= 2) {
        final hour = int.parse(parts[0]);
        final minute = parts[1];
        
        final period = hour >= 12 ? 'PM' : 'AM';
        
        final hour12 = hour % 12;
        final displayHour = hour12 == 0 ? 12 : hour12;
        
        return '${displayHour.toString().padLeft(2, '0')}:$minute $period';
      }
    } catch (e) {
      // print('Error formateando hora: $e');
    }
    return time;
  }

  @override
  Widget build(BuildContext context) {
    final formattedDate = _formatDate(date);
    final formattedTime = _formatTime(time);

    return Scaffold(
      appBar: AppBar(
        leading: IconButton(
          icon: const Icon(Icons.arrow_back, color: Color(0xFF333333)),
          onPressed: () => Navigator.pop(context),
        ),
        title: const Text('Detalles de la Cita'),
      ),
      body: SingleChildScrollView(
        child: Container(
          color: const Color(0xFFF2F0F4),
          padding: const EdgeInsets.all(16),
          child: Column(
          children: [
            const SizedBox(height: 40),

            // Icono de confirmación
            CircleAvatar(
              radius: 50,
              backgroundColor: const Color(0xFF7c4dff),
              child: const Icon(Icons.check, color: Colors.white, size: 50),
            ),

            const SizedBox(height: 20),

            // Título
            const Text(
              '¡Cita Confirmada!',
              style: TextStyle(
                fontSize: 24,
                fontWeight: FontWeight.bold,
              ),
            ),

            const SizedBox(height: 10),

            // Descripción
            Container(
              padding: const EdgeInsets.symmetric(horizontal: 20),
              child: const Text(
                'Tu salud es nuestra prioridad. Hemos agendado tu espacio exitosamente.',
                textAlign: TextAlign.center,
                style: TextStyle(color: Color(0xFF7c4dff), fontSize: 16),
              ),
            ),

            const SizedBox(height: 30),

              // Tarjeta del doctor
              Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: Colors.white,
                  borderRadius: BorderRadius.circular(12),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withValues(alpha: 0.05),
                      blurRadius: 10,
                      offset: const Offset(0, 4),
                    ),
                  ],
                ),
                child: Row(
                  children: [
                    CircleAvatar(
                      radius: 30,
                      backgroundColor: Colors.grey[300],
                      child: const Icon(Icons.person, size: 40),
                    ),
                    const SizedBox(width: 16),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Text(
                            doctorName,
                            style: const TextStyle(
                              fontWeight: FontWeight.bold,
                              fontSize: 16,
                            ),
                          ),
                          const SizedBox(height: 4),
                          Text(
                            specialty.toUpperCase(),
                            style: const TextStyle(
                              color: Color(0xFF7C3AED),
                              fontSize: 12,
                            ),
                          ),
                        ],
                      ),
                    )
                  ],
                ),
              ),

              const SizedBox(height: 16),

              // Fecha y Hora - Diseño mejorado
              Row(
                children: [
                  Expanded(
                    child: Container(
                      padding: const EdgeInsets.all(16),
                      decoration: BoxDecoration(
                        color: Colors.white,
                        borderRadius: BorderRadius.circular(12),
                        boxShadow: [
                          BoxShadow(
                            color: Colors.black.withValues(alpha: 0.05),
                            blurRadius: 8,
                            offset: const Offset(0, 2),
                          ),
                        ],
                      ),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Row(
                            children: [
                              Container(
                                padding: const EdgeInsets.all(8),
                                decoration: BoxDecoration(
                                  color: const Color(0xFF7c4dff).withValues(alpha: 0.1),
                                  borderRadius: BorderRadius.circular(8),
                                ),
                                child: const Icon(
                                  Icons.calendar_today,
                                  color: Color(0xFF7c4dff),
                                  size: 20,
                                ),
                              ),
                              const SizedBox(width: 12),
                              Expanded(
                                child: Column(
                                  crossAxisAlignment: CrossAxisAlignment.start,
                                  children: [
                                    const Text(
                                      'Fecha',
                                      style: TextStyle(
                                        color: Color(0xFF666666),
                                        fontSize: 12,
                                      ),
                                    ),
                                    const SizedBox(height: 2),
                                    Text(
                                      formattedDate,
                                      style: const TextStyle(
                                        fontWeight: FontWeight.bold,
                                        fontSize: 16,
                                      ),
                                    ),
                                  ],
                                ),
                              ),
                            ],
                          ),
                        ],
                      ),
                    ),
                  ),
                  const SizedBox(width: 12),
                  Expanded(
                    child: Container(
                      padding: const EdgeInsets.all(16),
                      decoration: BoxDecoration(
                        color: Colors.white,
                        borderRadius: BorderRadius.circular(12),
                        boxShadow: [
                          BoxShadow(
                            color: Colors.black.withValues(alpha: 0.05),
                            blurRadius: 8,
                            offset: const Offset(0, 2),
                          ),
                        ],
                      ),
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Row(
                            children: [
                              Container(
                                padding: const EdgeInsets.all(8),
                                decoration: BoxDecoration(
                                  color: const Color(0xFF7C3AED).withValues(alpha: 0.1),
                                  borderRadius: BorderRadius.circular(8),
                                ),
                                child: const Icon(
                                  Icons.access_time,
                                  color: Color(0xFF7C3AED),
                                  size: 20,
                                ),
                              ),
                              const SizedBox(width: 12),
                              Expanded(
                                child: Column(
                                  crossAxisAlignment: CrossAxisAlignment.start,
                                  children: [
                                    const Text(
                                      'Hora',
                                      style: TextStyle(
                                        color: Color(0xFF666666),
                                        fontSize: 12,
                                      ),
                                    ),
                                    const SizedBox(height: 2),
                                    Text(
                                      formattedTime,
                                      style: const TextStyle(
                                        fontWeight: FontWeight.bold,
                                        fontSize: 16,
                                      ),
                                    ),
                                  ],
                                ),
                              ),
                            ],
                          ),
                        ],
                      ),
                    ),
                  ),
                ],
              ),

              const SizedBox(height: 16),

              // Duración
              Container(
                padding: const EdgeInsets.all(16),
                decoration: BoxDecoration(
                  color: Colors.white,
                  borderRadius: BorderRadius.circular(12),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withValues(alpha: 0.05),
                      blurRadius: 8,
                      offset: const Offset(0, 2),
                    ),
                  ],
                ),
                child: Row(
                  children: [
                    Container(
                      padding: const EdgeInsets.all(8),
                      decoration: BoxDecoration(
                        color: const Color(0xFF21DEDB).withValues(alpha: 0.1),
                        borderRadius: BorderRadius.circular(8),
                      ),
                      child: const Icon(
                        Icons.timer,
                        color: Color(0xFF21DEDB),
                        size: 20,
                      ),
                    ),
                    const SizedBox(width: 12),
                    Expanded(
                      child: Column(
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          const Text(
                            'Duración estimada',
                            style: TextStyle(
                              fontWeight: FontWeight.bold,
                              fontSize: 14,
                            ),
                          ),
                          const SizedBox(height: 2),
                          Text(
                            'Sesión de $duration',
                            style: const TextStyle(
                              color: Color(0xFF666666),
                              fontSize: 12,
                            ),
                          ),
                        ],
                      ),
                    ),
                    Container(
                      padding: const EdgeInsets.symmetric(
                        horizontal: 8,
                        vertical: 4,
                      ),
                      decoration: BoxDecoration(
                        color: const Color(0xFF21DEDB).withValues(alpha: 0.1),
                        borderRadius: BorderRadius.circular(6),
                      ),
                      child: Text(
                        duration,
                        style: const TextStyle(
                          color: Color(0xFF00A8A6),
                          fontSize: 12,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                    ),
                  ],
                ),
              ),

const SizedBox(height: 40),

              // Botón con icono y texto blanco
              SizedBox(
                width: double.infinity,
                child: ElevatedButton(
                  onPressed: () {
                    // Agregar la cita al gestor de citas
                    AppointmentsManager().addAppointment(
                      specialty: specialty,
                      doctorName: doctorName,
                      date: date,
                      time: time,
                    );
                    
                    Navigator.pushAndRemoveUntil(
                      context,
                      MaterialPageRoute(builder: (context) => const MainNavigationScreen()),
                      (route) => false,
                    );
                  },
                  style: ElevatedButton.styleFrom(
                    backgroundColor: const Color(0xFF7c4dff),
                    padding: const EdgeInsets.all(18),
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(12),
                    ),
                  ),
                  child: const Row(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Icon(
                        Icons.check_circle,
                        color: Colors.white,
                        size: 24,
                      ),
                      SizedBox(width: 10),
                      Text(
                        'Confirmar Cita',
                        style: TextStyle(
                          fontWeight: FontWeight.bold,
                          fontSize: 16,
                          color: Colors.white,
                        ),
                      ),
                    ],
                  ),
                ),
              ),

              const SizedBox(height: 20),
            ],
          ),
        ),
      ),
    );
  }
}

// ------------------------------------------------------------
// PANTALLA DE PERFIL
// ------------------------------------------------------------
class ProfileScreen extends StatelessWidget {
  const ProfileScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        leading: IconButton(
          icon: const Icon(Icons.arrow_back, color: Color(0xFF333333)),
          onPressed: () => Navigator.pushReplacement(
            context,
            MaterialPageRoute(builder: (context) => const MainNavigationScreen()),
          ),
        ),
        title: const Text('Mi Perfil'),
      ),
      body: SingleChildScrollView(
        child: Column(
          children: [
            Column(
              children: [
                Container(
                  width: 128,
                  height: 128,
                  decoration: BoxDecoration(
                    gradient: const LinearGradient(
                      begin: Alignment.topLeft,
                      end: Alignment.bottomRight,
                      colors: [
                        Color(0xFFBD42ED),
                        Color(0xFF7c4dff),
                      ],
                    ),
                    borderRadius: BorderRadius.circular(64),
                    boxShadow: [
                      BoxShadow(
                        color: Colors.black.withValues(alpha: 0.1),
                        blurRadius: 10,
                        offset: const Offset(0, 4),
                      ),
                    ],
                  ),
                  padding: const EdgeInsets.all(4),
                  child: Container(
                    decoration: BoxDecoration(
                      color: const Color(0xFFBD42ED),
                      borderRadius: BorderRadius.circular(60),
                      border: Border.all(color: Colors.white, width: 4),
                    ),
                    child: const Center(
                      child: Text(
                        'J',
                        style: TextStyle(
                          color: Colors.white,
                          fontSize: 48,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                    ),
                  ),
                ),
                const SizedBox(height: 16),
                const Text(
                  'Juan Pérez García',
                  style: TextStyle(
                    fontSize: 24,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                const SizedBox(height: 8),
                Container(
                  padding: const EdgeInsets.symmetric(
                    horizontal: 12,
                    vertical: 4,
                  ),
                  decoration: BoxDecoration(
                    color: const Color(0xFF7c4dff).withValues(alpha: 0.1),
                    borderRadius: BorderRadius.circular(20),
                  ),
                  child: const Text(
                    'PACIENTE',
                    style: TextStyle(
                      color: Color(0xFF7c4dff),
                      fontSize: 10,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
              ],
            ),

            const SizedBox(height: 32),

            Padding(
              padding: const EdgeInsets.symmetric(horizontal: 16),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  const Text(
                    'INFORMACIÓN PERSONAL',
                    style: TextStyle(
                      fontSize: 12,
                      fontWeight: FontWeight.bold,
                      color: Colors.grey,
                      letterSpacing: 2,
                    ),
                  ),
                  const SizedBox(height: 16),

                  _buildInfoItemPerfil(
                    icon: Icons.person,
                    title: 'NOMBRE COMPLETO',
                    value: 'Juan Pérez García',
                    iconColor: const Color(0xFF7c4dff),
                  ),

                  const SizedBox(height: 12),

                  _buildInfoItemPerfil(
                    icon: Icons.fingerprint,
                    title: 'NÚMERO DE DNI',
                    value: '83758952',
                    iconColor: const Color(0xFF7c4dff),
                  ),

                  const SizedBox(height: 12),

                  _buildInfoItemPerfil(
                    icon: Icons.calendar_today,
                    title: 'Fecha de Nacimiento',
                    value: '15 de Mayo, 1990',
                    iconColor: const Color(0xFF7c4dff),
                  ),

                  const SizedBox(height: 12),

                  _buildInfoItemPerfil(
                    icon: Icons.cake,
                    title: 'Edad',
                    value: '33 años',
                    iconColor: const Color(0xFF7c4dff),
                  ),

                  const SizedBox(height: 12),

                  _buildInfoItemPerfil(
                    icon: Icons.phone,
                    title: 'Teléfono Móvil',
                    value: '+34 600 000 000',
                    iconColor: const Color(0xFF7c4dff),
                  ),

                  const SizedBox(height: 12),

                  _buildInfoItemPerfil(
                    icon: Icons.location_on,
                    title: 'Dirección Residencial',
                    value: 'Calle Falsa 123, Madrid',
                    iconColor: const Color(0xFF7c4dff),
                  ),

                  const SizedBox(height: 40),

                  Material(
                    borderRadius: BorderRadius.circular(12),
                    child: InkWell(
                      onTap: () {
                        Navigator.pushAndRemoveUntil(
                          context,
                          MaterialPageRoute(builder: (context) => const HealthConnectLogin()),
                          (route) => false,
                        );
                      },
                      borderRadius: BorderRadius.circular(12),
                      highlightColor: Colors.grey.withValues(alpha: 0.2),
                      splashColor: Colors.grey.withValues(alpha: 0.3),
                      child: Container(
                        height: 56,
                        decoration: BoxDecoration(
                          gradient: const LinearGradient(
                            colors: [
                              Color(0xFF7c4dff),
                              Color(0xFF9c27b0),
                            ],
                          ),
                          borderRadius: BorderRadius.circular(12),
                          boxShadow: [
                            BoxShadow(
                              color: Colors.black.withValues(alpha: 0.1),
                              blurRadius: 10,
                            ),
                          ],
                        ),
                        child: const Row(
                          mainAxisAlignment: MainAxisAlignment.center,
                          children: [
                            Icon(
                              Icons.logout,
                              color: Colors.white,
                              size: 24,
                            ),
                            SizedBox(width: 8),
                            Text(
                              'Cerrar Sesión',
                              style: TextStyle(
                                color: Colors.white,
                                fontSize: 16,
                                fontWeight: FontWeight.bold,
                              ),
                            ),
                          ],
                        ),
                      ),
                    ),
                  ),

                  const SizedBox(height: 40),
                ],
              ),
            ),
          ],
        ),
      ),
    );
  }

  Widget _buildInfoItemPerfil({
    required IconData icon,
    required String title,
    required String value,
    required Color iconColor,
  }) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(12),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withValues(alpha: 0.05),
            blurRadius: 10,
          ),
        ],
      ),
      child: Row(
        children: [
          Container(
            width: 48,
            height: 48,
            decoration: BoxDecoration(
              color: iconColor.withValues(alpha: 0.1),
              borderRadius: BorderRadius.circular(8),
            ),
            child: Icon(icon, color: iconColor, size: 24),
          ),
          const SizedBox(width: 16),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  title.toUpperCase(),
                  style: TextStyle(
                    fontSize: 10,
                    fontWeight: FontWeight.bold,
                    color: Colors.grey.shade600,
                    letterSpacing: 1,
                  ),
                ),
                const SizedBox(height: 4),
                Text(
                  value,
                  style: const TextStyle(
                    fontSize: 16,
                    fontWeight: FontWeight.w600,
                  ),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}

// ------------------------------------------------------------
// PANTALLA DE MIS CITAS
// ------------------------------------------------------------
class MyAppointmentsScreen extends StatefulWidget {
  const MyAppointmentsScreen({super.key});

  @override
  State<MyAppointmentsScreen> createState() => _MyAppointmentsScreenState();
}

class _MyAppointmentsScreenState extends State<MyAppointmentsScreen> {
  final AppointmentsManager _appointmentsManager = AppointmentsManager();

  void cancelAppointment(int id) {
    setState(() {
      _appointmentsManager.removeAppointment(id);
    });
  }

  @override
  Widget build(BuildContext context) {
    final appointments = _appointmentsManager.appointments;
    
    return Scaffold(
      appBar: AppBar(
        leading: IconButton(
          icon: const Icon(Icons.arrow_back, color: Color(0xFF333333)),
          onPressed: () => Navigator.pushReplacement(
            context,
            MaterialPageRoute(builder: (context) => const MainNavigationScreen()),
          ),
        ),
        title: const Text('Mis Citas'),
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(16),
        child: Column(
          children: [
            Row(
              mainAxisAlignment: MainAxisAlignment.spaceBetween,
              children: [
                const Text(
                  'Lista de Citas',
                  style: TextStyle(
                    fontSize: 24,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                Container(
                  padding: const EdgeInsets.symmetric(
                    horizontal: 12,
                    vertical: 4,
                  ),
                  decoration: BoxDecoration(
                    color: const Color(0xFF21DEDB).withValues(alpha: 0.1),
                    borderRadius: BorderRadius.circular(20),
                  ),
                  child: Text(
                    '${appointments.length} Activas',
                    style: const TextStyle(
                      color: Color(0xFF00A8A6),
                      fontSize: 10,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
              ],
            ),
            const SizedBox(height: 6),
            Align(
              alignment: Alignment.centerLeft,
              child: Container(
                height: 3,
                width: 60,
                decoration: BoxDecoration(
                  color: const Color(0xFF7c4dff),
                  borderRadius: BorderRadius.circular(2),
                ),
              ),
            ),
            const SizedBox(height: 20),

            if (appointments.isEmpty)
              Container(
                padding: const EdgeInsets.all(40),
                decoration: BoxDecoration(
                  color: Colors.white,
                  borderRadius: BorderRadius.circular(16),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black.withValues(alpha: 0.05),
                      blurRadius: 10,
                      offset: const Offset(0, 4),
                    ),
                  ],
                ),
                child: const Column(
                  children: [
                    Icon(
                      Icons.calendar_today,
                      size: 60,
                      color: Colors.grey,
                    ),
                    SizedBox(height: 16),
                    Text(
                      'No tienes citas programadas',
                      style: TextStyle(
                        fontSize: 16,
                        color: Colors.grey,
                      ),
                    ),
                  ],
                ),
              )
            else
              Column(
                children: appointments.map((appointment) {
                  return Column(
                    children: [
                      _buildAppointmentCard(
                        specialty: appointment['specialty'] as String,
                        doctorName:
                            appointment['doctorName'] as String,
                        date: appointment['date'] as String,
                        time: appointment['time'] as String,
                        icon: appointment['icon'] as IconData,
                        iconColor:
                            appointment['iconColor'] as Color,
                        onCancel: () =>
                            cancelAppointment(appointment['id'] as int),
                      ),
                      const SizedBox(height: 16),
                    ],
                  );
                }).toList(),
              ),
          ],
        ),
      ),
    );
  }

  Widget _buildAppointmentCard({
    required String specialty,
    required String doctorName,
    required String date,
    required String time,
    required IconData icon,
    required Color iconColor,
    required VoidCallback onCancel,
  }) {
    return Container(
      padding: const EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(16),
        boxShadow: [
          BoxShadow(
            color: Colors.black.withValues(alpha: 0.05),
            blurRadius: 8,
            offset: const Offset(0, 4),
          ),
        ],
      ),
      child: Column(
        children: [
          Row(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              Container(
                width: 56,
                height: 56,
                decoration: BoxDecoration(
                  color: iconColor.withValues(alpha: 0.1),
                  borderRadius: BorderRadius.circular(12),
                ),
                child: Icon(icon, color: iconColor, size: 32),
              ),

              const SizedBox(width: 16),

              Expanded(
                child: Column(
                  crossAxisAlignment: CrossAxisAlignment.start,
                  children: [
                    Text(
                      specialty.toUpperCase(),
                      style: TextStyle(
                        color: iconColor,
                        fontSize: 10,
                        fontWeight: FontWeight.bold,
                        letterSpacing: 1,
                      ),
                    ),

                    const SizedBox(height: 4),

                    Text(
                      doctorName,
                      style: const TextStyle(
                        fontSize: 18,
                        fontWeight: FontWeight.bold,
                      ),
                    ),

                    const SizedBox(height: 8),

                    Row(
                      children: [
                        Row(
                          children: [
                            const Icon(
                              Icons.calendar_today,
                              size: 14,
                              color: Colors.grey,
                            ),
                            const SizedBox(width: 4),
                            Text(
                              date,
                              style: const TextStyle(
                                color: Colors.grey,
                                fontSize: 14,
                              ),
                            ),
                          ],
                        ),

                        const SizedBox(width: 16),

                        Row(
                          children: [
                            const Icon(
                              Icons.access_time,
                              size: 14,
                              color: Colors.grey,
                            ),
                            const SizedBox(width: 4),
                            Text(
                              time,
                              style: const TextStyle(
                                color: Colors.grey,
                                fontSize: 14,
                              ),
                            ),
                          ],
                        ),
                      ],
                    ),
                  ],
                ),
              ),
            ],
          ),

          const SizedBox(height: 16),

          Material(
            borderRadius: BorderRadius.circular(12),
            child: InkWell(
              onTap: onCancel,
              borderRadius: BorderRadius.circular(12),
              highlightColor: Colors.red.withValues(alpha: 0.1),
              splashColor: Colors.red.withValues(alpha: 0.2),
              child: Container(
                width: double.infinity,
                padding: const EdgeInsets.symmetric(vertical: 12),
                decoration: BoxDecoration(
                  color: const Color(0xFFFEF2F2),
                  borderRadius: BorderRadius.circular(12),
                  border: Border.all(
                    color: Colors.red.shade100,
                    width: 1,
                  ),
                ),
                child: const Center(
                  child: Text(
                    'Cancelar Cita',
                    style: TextStyle(
                      fontSize: 14,
                      fontWeight: FontWeight.bold,
                      color: Color(0xFFDC2626),
                    ),
                  ),
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }
}

// ------------------------------------------------------------
// CLASES AUXILIARES
// ------------------------------------------------------------

// Clase para manejar el estado global de las citas
class AppointmentsManager {
  static final AppointmentsManager _instance = AppointmentsManager._internal();
  factory AppointmentsManager() => _instance;
  AppointmentsManager._internal();

  final List<Map<String, dynamic>> _appointments = [];

  List<Map<String, dynamic>> get appointments => List.from(_appointments);

  void addAppointment({
    required String specialty,
    required String doctorName,
    required String date,
    required String time,
  }) {
    _appointments.add({
      'id': DateTime.now().millisecondsSinceEpoch,
      'specialty': specialty,
      'doctorName': doctorName,
      'date': date,
      'time': time,
      'icon': _getIconForSpecialty(specialty),
      'iconColor': _getColorForSpecialty(specialty),
    });
  }

  void removeAppointment(int id) {
    _appointments.removeWhere((appointment) => appointment['id'] == id);
  }

  IconData _getIconForSpecialty(String specialty) {
    switch (specialty.toLowerCase()) {
      case 'cardiología':
        return Icons.favorite;
      case 'psicología':
        return Icons.psychology;
      case 'odontología':
        return Icons.medical_services;
      case 'dermatología':
        return Icons.spa;
      case 'gastroenterología':
        return Icons.medical_information;
      case 'neurología':
        return Icons.memory;
      case 'oftalmología':
        return Icons.remove_red_eye;
      case 'pediatría':
        return Icons.child_care;
      default:
        return Icons.medical_services;
    }
  }

  Color _getColorForSpecialty(String specialty) {
    switch (specialty.toLowerCase()) {
      case 'cardiología':
        return const Color(0xFF21DEDB);
      case 'psicología':
        return const Color(0xFF9B8ACB);
      case 'odontología':
        return const Color(0xFF21DEDB);
      case 'dermatología':
        return const Color(0xFFFFB74D);
      case 'gastroenterología':
        return const Color(0xFF4CAF50);
      case 'neurología':
        return const Color(0xFF2196F3);
      case 'oftalmología':
        return const Color(0xFF9C27B0);
      case 'pediatría':
        return const Color(0xFFFF9800);
      default:
        return const Color(0xFF7c4dff);
    }
  }
}

// Clase para formatear el número de teléfono que OBLIGA a empezar con 9
class _PhoneStartsWithNineFormatter extends TextInputFormatter {
  @override
  TextEditingValue formatEditUpdate(
    TextEditingValue oldValue,
    TextEditingValue newValue,
  ) {
    if (newValue.text.isEmpty) {
      return newValue;
    }

    final digits = newValue.text.replaceAll(RegExp(r'[^0-9]'), '');

    if (digits.isEmpty) {
      return oldValue;
    }

    String formattedText;
    
    if (oldValue.text.isEmpty) {
      if (digits[0] != '9') {
        return oldValue;
      }
      formattedText = digits.substring(0, digits.length.clamp(0, 9));
    } else {
      final oldDigits = oldValue.text.replaceAll(RegExp(r'[^0-9]'), '');
      
      final hasNineAtStart = oldDigits.isNotEmpty && oldDigits[0] == '9';
      
      if (hasNineAtStart) {
        formattedText = digits.substring(0, digits.length.clamp(0, 9));
      } else {
        if (digits.isNotEmpty && digits[0] == '9') {
          formattedText = digits.substring(0, digits.length.clamp(0, 9));
        } else {
          return oldValue;
        }
      }
    }

    return TextEditingValue(
      text: formattedText,
      selection: TextSelection.collapsed(offset: formattedText.length),
    );
  }
}

// Clase para formatear y validar fecha de nacimiento
class _DateInputFormatter extends TextInputFormatter {
  @override
  TextEditingValue formatEditUpdate(
    TextEditingValue oldValue,
    TextEditingValue newValue,
  ) {
    if (newValue.text.isEmpty) {
      return newValue;
    }

    String digits = newValue.text.replaceAll(RegExp(r'[^0-9]'), '');

    if (digits.length > 8) {
      digits = digits.substring(0, 8);
    }

    for (int i = 0; i < digits.length; i++) {
      final char = digits[i];
      final intValue = int.parse(char);
      
      if (i == 0) {
        if (intValue > 3) {
          digits = _replaceCharAt(digits, i, '3');
        }
      } else if (i == 1) {
        if (digits.isNotEmpty) {
          final firstDayDigit = int.parse(digits[0]);
          if (firstDayDigit == 0) {
            if (intValue < 1) {
              digits = _replaceCharAt(digits, i, '1');
            }
          } else if (firstDayDigit == 3) {
            if (intValue > 1) {
              digits = _replaceCharAt(digits, i, '1');
            }
          }
        }
      } else if (i == 2) {
        if (intValue > 1) {
          digits = _replaceCharAt(digits, i, '1');
        }
      } else if (i == 3) {
        if (digits.length > 2) {
          final firstMonthDigit = int.parse(digits[2]);
          if (firstMonthDigit == 0) {
            if (intValue < 1) {
              digits = _replaceCharAt(digits, i, '1');
            }
          } else if (firstMonthDigit == 1) {
            if (intValue > 2) {
              digits = _replaceCharAt(digits, i, '2');
            }
          }
        }
      } else if (i == 4) {
        if (intValue < 1) {
          digits = _replaceCharAt(digits, i, '1');
        } else if (intValue > 2) {
          digits = _replaceCharAt(digits, i, '2');
        }
      }
    }

    String formatted = '';
    for (int i = 0; i < digits.length; i++) {
      if (i == 2 || i == 4) {
        formatted += '/';
      }
      formatted += digits[i];
    }

    return TextEditingValue(
      text: formatted,
      selection: TextSelection.collapsed(offset: formatted.length),
    );
  }

  String _replaceCharAt(String str, int index, String newChar) {
    return str.substring(0, index) + newChar + str.substring(index + 1);
  }
}
